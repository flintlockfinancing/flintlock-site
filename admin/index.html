<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flintlock | Admin Demo Console</title>
  <meta name="description" content="Flintlock Financing demo environment (admin console). Policy-driven controls and audit visibility." />

  <style>
    :root{
      --bg: #071726;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.04);
      --text: rgba(255,255,255,0.90);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);
      --line: rgba(255,255,255,0.12);
      --accent: #C57B2A;
      --accent2: #E2A45D;
      --white: #ffffff;
      --shadow: 0 18px 40px rgba(0,0,0,0.40);
      --radius: 18px;
      --max: 1200px;
      --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --danger: #ff6b6b;
      --warn: #ffd166;
      --ok: #86efac;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(900px 400px at 20% 0%, rgba(197,123,42,0.18), transparent 55%),
                  radial-gradient(700px 350px at 90% 10%, rgba(226,164,93,0.12), transparent 55%),
                  linear-gradient(180deg, #061424 0%, #071726 55%, #05101C 100%);
      color: var(--text);
      line-height: 1.45;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width: var(--max); margin:0 auto; padding: 0 18px}
    .topbar{
      position: sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(5,16,28,0.62);
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; padding: 14px 0;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .mark{
      width: 32px; height: 32px; border-radius: 10px;
      background:
        radial-gradient(10px 10px at 70% 30%, rgba(255,255,255,0.9), transparent 55%),
        radial-gradient(18px 18px at 65% 35%, rgba(226,164,93,0.65), transparent 60%),
        linear-gradient(180deg, rgba(197,123,42,0.95), rgba(197,123,42,0.35));
      box-shadow: 0 10px 22px rgba(197,123,42,0.25);
      border: 1px solid rgba(255,255,255,0.15);
    }
    .brand-text{display:flex; flex-direction:column; line-height:1.1}
    .brand-text strong{
      font-family: var(--serif);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
    }
    .brand-text span{font-size:12px; color: var(--muted2)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding: 10px 13px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      font-size: 13px;
      cursor:pointer;
      transition: transform 0.06s ease, background 0.2s ease, border-color 0.2s ease;
      user-select:none; white-space:nowrap;
    }
    .btn:hover{background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.20)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(197,123,42,0.55);
      background: linear-gradient(180deg, rgba(197,123,42,0.95), rgba(197,123,42,0.55));
      box-shadow: 0 16px 34px rgba(197,123,42,0.18);
      color: #0b1016;
      font-weight: 800;
    }
    .btn.ghost{background:transparent}
    .pill{
      display:inline-flex; gap:10px; align-items:center;
      padding: 7px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 12px;
    }
    .spark{
      width: 8px; height: 8px; border-radius: 999px;
      background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(226,164,93,0.95) 35%, rgba(197,123,42,0.5) 65%, transparent 70%);
      box-shadow: 0 0 22px rgba(226,164,93,0.50);
    }
    h1{
      font-family: var(--serif);
      font-size: clamp(22px, 3.2vw, 34px);
      margin: 18px 0 6px;
    }
    .sub{color: var(--muted); font-size: 14px; margin: 0 0 14px}
    .layout{
      display:grid;
      grid-template-columns: 290px 1fr;
      gap: 14px;
      padding: 14px 0 30px;
    }
    .card{
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .nav{
      display:flex; flex-direction:column; gap: 8px;
      position: sticky; top: 72px;
    }
    .nav a{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.82);
      font-size: 13px;
    }
    .nav a.active{
      border-color: rgba(197,123,42,0.40);
      background: rgba(197,123,42,0.10);
    }
    .note{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      color: var(--muted2);
      font-size: 12px;
    }
    .hr{height:1px; background: rgba(255,255,255,0.08); margin: 12px 0}
    .field{display:flex; flex-direction:column; gap:6px; margin-top: 10px}
    label{font-size: 12px; color: var(--muted2)}
    input, select, textarea{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.92);
      outline:none;
      font-size: 14px;
    }
    textarea{min-height: 90px; resize: vertical}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap: 12px}
    .grid3{display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    table{width:100%; border-collapse: collapse; font-size: 13px}
    th, td{padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.07)}
    th{text-align:left; color: rgba(255,255,255,0.80); font-weight: 700; background: rgba(255,255,255,0.03)}
    td{color: rgba(255,255,255,0.86)}
    .right{text-align:right}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.80);
      font-size: 12px;
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(134,239,172,0.25); background: rgba(134,239,172,0.08)}
    .badge.warn{border-color: rgba(255,209,102,0.25); background: rgba(255,209,102,0.08)}
    .badge.bad{border-color: rgba(255,107,107,0.25); background: rgba(255,107,107,0.08)}
    .toolbar{display:flex; justify-content:space-between; gap: 10px; flex-wrap:wrap; align-items:center; margin-top: 10px}
    .small{font-size:12px; color: var(--muted2)}
    .split{display:grid; grid-template-columns: 1.1fr 0.9fr; gap: 12px}
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr}
      .nav{position: relative; top:auto}
      .grid2, .grid3, .split{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="container">
      <div class="topbar-inner">
        <a class="brand" href="/" aria-label="Back to Flintlock home">
          <div class="mark" aria-hidden="true"></div>
          <div class="brand-text">
            <strong>Flintlock Financing</strong>
            <span>Admin Demo Console</span>
          </div>
        </a>

        <div class="row">
          <span class="pill"><span class="spark" aria-hidden="true"></span><span>DEMO / TEST ENVIRONMENT</span></span>
          <button class="btn ghost" id="btnSeed" type="button">Reseed data</button>
          <button class="btn ghost" id="btnClear" type="button">Clear local data</button>
          <a class="btn" href="/app">Consumer portal</a>
          <a class="btn primary" href="#/queue">Open queue</a>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <h1>Policy-driven underwriting controls</h1>
    <p class="sub">
      This console demonstrates configurable policy thresholds, a review queue, decision overrides, and an append-only audit log.
      All data is synthetic and stored locally in your browser for demo persistence.
    </p>

    <div class="layout">
      <aside class="card nav" id="nav">
        <a href="#/queue" data-route="queue">Application queue</a>
        <a href="#/policy" data-route="policy">Policy configuration</a>
        <a href="#/audit" data-route="audit">Audit log</a>
        <a href="#/about" data-route="about">About this demo</a>

        <div class="note">
          <strong>Demo disclaimer:</strong> No real credit decisions are made. No credit pulls. No banking integrations.
          All “applications” and “events” are synthetic.
        </div>
      </aside>

      <section class="card" id="view"></section>
    </div>
  </main>

<script>
(() => {
  // ---- Storage keys ----
  const KEY_POLICY = "flintlock_demo_policy_v1";
  const KEY_APPS   = "flintlock_demo_apps_v1";
  const KEY_AUDIT  = "flintlock_demo_audit_v1";

  // ---- Defaults ----
  const DEFAULT_POLICY = {
    minScore: 620,
    maxTicket: 12000,
    termCaps: [
      { max: 1500, term: 24 },
      { max: 2500, term: 36 },
      { max: 999999, term: 48 }
    ],
    residualPct: 0.20,
    residualFloor: 200,
    moneyFactor: 0.0030,
    updatedAt: new Date().toISOString()
  };

  // Seeded “applications” for queue demo
  function seededApps(){
    const now = Date.now();
    return [
      mkApp("A-10021", "Prime Applicant", 720, 4500, "Submitted", { fraud:false, idMismatch:false }, now - 1000*60*22),
      mkApp("A-10022", "Near Prime Applicant", 640, 2100, "Submitted", { fraud:false, idMismatch:false }, now - 1000*60*18),
      mkApp("A-10023", "Fraud Flag", 700, 5800, "Manual Review", { fraud:true, idMismatch:false }, now - 1000*60*14),
      mkApp("A-10024", "Identity Mismatch", 700, 3200, "Declined", { fraud:false, idMismatch:true }, now - 1000*60*10),
      mkApp("A-10025", "Below Minimum Score", 590, 1200, "Declined", { fraud:false, idMismatch:false }, now - 1000*60*6),
    ];
  }

  function mkApp(id, personaName, score, price, status, flags, createdAtMs){
    const name = personaName.includes("Applicant") ? "Alex Morgan" : (personaName === "Fraud Flag" ? "Jordan Lee" : "Taylor Quinn");
    return {
      id,
      applicantName: name,
      email: name.toLowerCase().replace(" ", ".") + "@example.com",
      phone: "(555) 555-1212",
      score,
      price,
      item: "Illustrative Merchant Item",
      status,
      flags,
      createdAt: new Date(createdAtMs).toISOString(),
      updatedAt: new Date(createdAtMs).toISOString(),
      reviewerNote: "",
      lastDecision: status === "Declined" ? "DECLINE" : (status === "Manual Review" ? "MANUAL_REVIEW" : (status === "Submitted" ? "PENDING" : "PENDING"))
    };
  }

  // ---- Helpers ----
  const fmtUSD = (n) => new Intl.NumberFormat("en-US", { style:"currency", currency:"USD" }).format(Number(n||0));
  const mono = (s) => `<span class="mono">${escapeHtml(s)}</span>`;

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return structuredClone(fallback);
      return JSON.parse(raw);
    } catch(e){
      return structuredClone(fallback);
    }
  }
  function saveJSON(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function nowISO(){ return new Date().toISOString(); }

  function termFor(policy, price){
    for(const cap of policy.termCaps){
      if(price <= cap.max) return cap.term;
    }
    return policy.termCaps[policy.termCaps.length-1].term;
  }

  function residualFor(policy, price){
    const r = price * policy.residualPct;
    return Math.max(policy.residualFloor, Math.round(r));
  }

  function paymentFor(policy, price, residual, term){
    const dep = (price - residual) / term;
    const rent = (price + residual) * policy.moneyFactor;
    return Math.round((dep + rent) * 100) / 100;
  }

  function evaluate(policy, app){
    // Policy-driven decision logic (demo)
    const reasons = [];
    if(app.price > policy.maxTicket) reasons.push(`Ticket exceeds maximum (${fmtUSD(policy.maxTicket)}).`);
    if(app.score < policy.minScore) reasons.push(`Score below minimum (${policy.minScore}).`);

    if(app.flags.idMismatch){
      return { outcome:"DECLINE", badge:"bad", summary:"Declined due to identity mismatch.", reasons: ["Identity verification mismatch (demo).", ...reasons] };
    }
    if(app.flags.fraud){
      return { outcome:"MANUAL_REVIEW", badge:"warn", summary:"Routed to manual review due to fraud indicator.", reasons };
    }
    if(reasons.length){
      return { outcome:"DECLINE", badge:"bad", summary:"Declined due to policy constraint.", reasons };
    }
    return { outcome:"APPROVE", badge:"ok", summary:"Approved per policy.", reasons: [] };
  }

  function badgeForOutcome(outcome){
    if(outcome === "APPROVE") return { cls:"ok", text:"Approved" };
    if(outcome === "MANUAL_REVIEW") return { cls:"warn", text:"Manual review" };
    return { cls:"bad", text:"Declined" };
  }

  // ---- Audit ----
  function auditAppend(event){
    const log = loadJSON(KEY_AUDIT, []);
    log.unshift(event);
    saveJSON(KEY_AUDIT, log.slice(0, 500)); // cap
  }

  function mkEvent(type, details){
    return {
      ts: nowISO(),
      type,
      actor: "admin.demo@flintlockfinancing.com",
      details
    };
  }

  // ---- State ----
  let policy = loadJSON(KEY_POLICY, DEFAULT_POLICY);
  let apps   = loadJSON(KEY_APPS, seededApps());
  let selectedId = null;

  // First run seed
  if(!localStorage.getItem(KEY_POLICY)) saveJSON(KEY_POLICY, policy);
  if(!localStorage.getItem(KEY_APPS)) saveJSON(KEY_APPS, apps);
  if(!localStorage.getItem(KEY_AUDIT)){
    saveJSON(KEY_AUDIT, []);
    auditAppend(mkEvent("system.init", "Initialized demo environment (synthetic)."));
  }

  const viewEl = document.getElementById("view");
  const navEl  = document.getElementById("nav");

  function route(){
    const h = location.hash || "#/queue";
    if(h.startsWith("#/policy")) return "policy";
    if(h.startsWith("#/audit")) return "audit";
    if(h.startsWith("#/about")) return "about";
    return "queue";
  }

  function setActiveNav(){
    const r = route();
    navEl.querySelectorAll("a[data-route]").forEach(a => {
      a.classList.toggle("active", a.dataset.route === r);
    });
  }

  function renderQueue(){
    setActiveNav();
    const rpolicy = policy;
    const rows = apps
      .slice()
      .sort((a,b)=> new Date(b.updatedAt) - new Date(a.updatedAt))
      .map(app => {
        const evald = evaluate(rpolicy, app);
        const badge = badgeForOutcome(evald.outcome);
        const term = termFor(rpolicy, app.price);
        return `
          <tr>
            <td>${mono(app.id)}</td>
            <td>${escapeHtml(app.applicantName)}</td>
            <td class="right">${mono(String(app.score))}</td>
            <td class="right">${fmtUSD(app.price)}</td>
            <td class="right">${mono(String(term))}</td>
            <td><span class="badge ${badge.cls}">${badge.text}</span></td>
            <td class="right"><button class="btn" data-open="${escapeHtml(app.id)}" type="button">Open</button></td>
          </tr>
        `;
      }).join("");

    viewEl.innerHTML = `
      <h2 style="margin:0 0 8px; font-family:var(--serif);">Application queue</h2>
      <p class="sub" style="margin-top:0;">
        Review seeded applications, evaluate outcomes using current policy, and record override actions with audit events.
      </p>

      <div class="toolbar">
        <div class="row">
          <span class="badge">Policy: min score ${mono(String(policy.minScore))}</span>
          <span class="badge">Max ticket ${mono(fmtUSD(policy.maxTicket))}</span>
        </div>
        <div class="row">
          <button class="btn ghost" id="btnNewApp" type="button">Add synthetic application</button>
          <a class="btn primary" href="#/policy">Edit policy</a>
        </div>
      </div>

      <div class="hr"></div>

      <div style="overflow:auto; border:1px solid rgba(255,255,255,0.10); border-radius:14px;">
        <table>
          <thead>
            <tr>
              <th>Application</th>
              <th>Applicant</th>
              <th class="right">Score</th>
              <th class="right">Ticket</th>
              <th class="right">Term</th>
              <th>Policy outcome</th>
              <th class="right">Action</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>

      <div class="note">
        <strong>Note:</strong> The “Policy outcome” shown is computed from current thresholds.
        Use “Open” to document an override decision and create an audit entry.
      </div>
    `;

    viewEl.querySelectorAll("button[data-open]").forEach(btn => {
      btn.addEventListener("click", () => {
        selectedId = btn.getAttribute("data-open");
        renderAppDetail(selectedId);
      });
    });

    viewEl.querySelector("#btnNewApp").addEventListener("click", () => {
      const idNum = 10000 + Math.floor(Math.random()*9000);
      const app = mkApp(`A-${idNum}`, "Synthetic Applicant", 660, 3800, "Submitted", { fraud:false, idMismatch:false }, Date.now());
      apps.unshift(app);
      saveJSON(KEY_APPS, apps);
      auditAppend(mkEvent("app.created", `Created ${app.id} (${app.applicantName}) ticket ${fmtUSD(app.price)} score ${app.score}.`));
      renderQueue();
    });
  }

  function renderAppDetail(appId){
    setActiveNav();
    const app = apps.find(a => a.id === appId);
    if(!app){ location.hash = "#/queue"; return; }

    const evald = evaluate(policy, app);
    const badge = badgeForOutcome(evald.outcome);
    const term = termFor(policy, app.price);
    const residual = residualFor(policy, app.price);
    const payment = paymentFor(policy, app.price, residual, term);
    const total = Math.round(payment*term*100)/100;

    viewEl.innerHTML = `
      <div class="row" style="justify-content:space-between; align-items:flex-start; gap:12px;">
        <div>
          <h2 style="margin:0; font-family:var(--serif);">Application ${mono(app.id)}</h2>
          <div class="small">Created ${escapeHtml(app.createdAt)} • Updated ${escapeHtml(app.updatedAt)}</div>
        </div>
        <div class="row">
          <a class="btn ghost" href="#/queue">Back to queue</a>
          <a class="btn" href="#/audit">View audit log</a>
        </div>
      </div>

      <div class="hr"></div>

      <div class="split">
        <div>
          <h3 style="margin:0 0 6px; letter-spacing:0.08em; text-transform:uppercase; font-size:13px; color:rgba(255,255,255,0.86);">Applicant</h3>
          <div class="grid2">
            <div class="field">
              <label>Name</label>
              <input value="${escapeHtml(app.applicantName)}" disabled />
            </div>
            <div class="field">
              <label>Score (synthetic)</label>
              <input value="${escapeHtml(String(app.score))}" disabled />
            </div>
            <div class="field">
              <label>Email</label>
              <input value="${escapeHtml(app.email)}" disabled />
            </div>
            <div class="field">
              <label>Phone</label>
              <input value="${escapeHtml(app.phone)}" disabled />
            </div>
          </div>

          <div class="hr"></div>

          <h3 style="margin:0 0 6px; letter-spacing:0.08em; text-transform:uppercase; font-size:13px; color:rgba(255,255,255,0.86);">Transaction</h3>
          <div class="grid2">
            <div class="field">
              <label>Item</label>
              <input value="${escapeHtml(app.item)}" disabled />
            </div>
            <div class="field">
              <label>Ticket</label>
              <input value="${escapeHtml(fmtUSD(app.price))}" disabled />
            </div>
          </div>

          <div class="note">
            Flags: 
            <span class="mono">fraud=${app.flags.fraud ? "true" : "false"}</span>, 
            <span class="mono">idMismatch=${app.flags.idMismatch ? "true" : "false"}</span>
          </div>
        </div>

        <div>
          <h3 style="margin:0 0 6px; letter-spacing:0.08em; text-transform:uppercase; font-size:13px; color:rgba(255,255,255,0.86);">Policy evaluation</h3>
          <div class="row" style="margin-bottom:10px;">
            <span class="badge ${badge.cls}">${badge.text}</span>
            <span class="badge">Term cap ${mono(String(term))} mo</span>
            <span class="badge">Residual ${mono(fmtUSD(residual))}</span>
          </div>

          <div class="note">
            <strong>Summary:</strong> ${escapeHtml(evald.summary)}
            ${evald.reasons.length ? `<div style="margin-top:8px;"><strong>Reasons:</strong><ul>${evald.reasons.map(r=>`<li>${escapeHtml(r)}</li>`).join("")}</ul></div>` : ""}
          </div>

          <div class="hr"></div>

          <h3 style="margin:0 0 6px; letter-spacing:0.08em; text-transform:uppercase; font-size:13px; color:rgba(255,255,255,0.86);">Illustrative offer math</h3>
          <div class="grid3">
            <div class="field"><label>Payment</label><input value="${fmtUSD(payment)}" disabled></div>
            <div class="field"><label>Total of payments</label><input value="${fmtUSD(total)}" disabled></div>
            <div class="field"><label>Purchase option</label><input value="${fmtUSD(residual)}" disabled></div>
          </div>

          <div class="hr"></div>

          <h3 style="margin:0 0 6px; letter-spacing:0.08em; text-transform:uppercase; font-size:13px; color:rgba(255,255,255,0.86);">Decision override</h3>
          <div class="grid2">
            <div class="field">
              <label>Set status</label>
              <select id="overrideStatus">
                <option value="Submitted" ${app.status==="Submitted"?"selected":""}>Submitted</option>
                <option value="Manual Review" ${app.status==="Manual Review"?"selected":""}>Manual Review</option>
                <option value="Approved" ${app.status==="Approved"?"selected":""}>Approved</option>
                <option value="Declined" ${app.status==="Declined"?"selected":""}>Declined</option>
              </select>
            </div>
            <div class="field">
              <label>Record decision</label>
              <select id="overrideDecision">
                <option value="PENDING" ${app.lastDecision==="PENDING"?"selected":""}>Pending</option>
                <option value="APPROVE" ${app.lastDecision==="APPROVE"?"selected":""}>Approve</option>
                <option value="MANUAL_REVIEW" ${app.lastDecision==="MANUAL_REVIEW"?"selected":""}>Manual review</option>
                <option value="DECLINE" ${app.lastDecision==="DECLINE"?"selected":""}>Decline</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label>Reviewer note</label>
            <textarea id="reviewerNote" placeholder="Add a note for the audit trail (demo).">${escapeHtml(app.reviewerNote||"")}</textarea>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn primary" id="btnSaveOverride" type="button">Save override + audit</button>
            <button class="btn" id="btnClose" type="button">Close</button>
          </div>

          <div class="note">
            Overrides are logged as audit events with timestamp, actor, and free-text note.
          </div>
        </div>
      </div>
    `;

    viewEl.querySelector("#btnClose").addEventListener("click", () => location.hash = "#/queue");

    viewEl.querySelector("#btnSaveOverride").addEventListener("click", () => {
      const status = viewEl.querySelector("#overrideStatus").value;
      const decision = viewEl.querySelector("#overrideDecision").value;
      const note = viewEl.querySelector("#reviewerNote").value || "";

      app.status = status;
      app.lastDecision = decision;
      app.reviewerNote = note;
      app.updatedAt = nowISO();

      saveJSON(KEY_APPS, apps);

      auditAppend(mkEvent(
        "app.override",
        `Override ${app.id}: status=${status}, decision=${decision}, note="${note.replaceAll('"','\\"')}".`
      ));

      renderAppDetail(app.id);
    });
  }

  function renderPolicy(){
    setActiveNav();

    viewEl.innerHTML = `
      <h2 style="margin:0 0 8px; font-family:var(--serif);">Policy configuration</h2>
      <p class="sub" style="margin-top:0;">
        Edit underwriting guardrails and pricing inputs. Changes apply to the computed “policy outcome” and offer math.
      </p>

      <div class="hr"></div>

      <div class="grid2">
        <div class="field">
          <label>Minimum score</label>
          <input id="minScore" type="number" min="300" max="850" step="1" value="${escapeHtml(String(policy.minScore))}">
        </div>
        <div class="field">
          <label>Maximum ticket size</label>
          <input id="maxTicket" type="number" min="500" max="50000" step="50" value="${escapeHtml(String(policy.maxTicket))}">
        </div>
      </div>

      <div class="grid3">
        <div class="field">
          <label>Term cap 1 (≤ price)</label>
          <input id="cap1max" type="number" value="${escapeHtml(String(policy.termCaps[0].max))}">
        </div>
        <div class="field">
          <label>Term cap 1 (months)</label>
          <input id="cap1term" type="number" value="${escapeHtml(String(policy.termCaps[0].term))}">
        </div>
        <div class="field">
          <label>—</label>
          <div class="small">Under $1,500 → 24 months (default)</div>
        </div>

        <div class="field">
          <label>Term cap 2 (≤ price)</label>
          <input id="cap2max" type="number" value="${escapeHtml(String(policy.termCaps[1].max))}">
        </div>
        <div class="field">
          <label>Term cap 2 (months)</label>
          <input id="cap2term" type="number" value="${escapeHtml(String(policy.termCaps[1].term))}">
        </div>
        <div class="field">
          <label>—</label>
          <div class="small">Under $2,500 → 36 months (default)</div>
        </div>

        <div class="field">
          <label>Term cap 3 (months)</label>
          <input id="cap3term" type="number" value="${escapeHtml(String(policy.termCaps[2].term))}">
        </div>
        <div class="field">
          <label>Residual % (0–1)</label>
          <input id="residualPct" type="number" min="0" max="1" step="0.01" value="${escapeHtml(String(policy.residualPct))}">
        </div>
        <div class="field">
          <label>Money factor</label>
          <input id="moneyFactor" type="number" min="0" max="0.02" step="0.0001" value="${escapeHtml(String(policy.moneyFactor))}">
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <label>Residual floor ($)</label>
          <input id="residualFloor" type="number" min="0" step="10" value="${escapeHtml(String(policy.residualFloor))}">
        </div>
        <div class="field">
          <label>Last updated</label>
          <input value="${escapeHtml(policy.updatedAt || "")}" disabled>
        </div>
      </div>

      <div class="toolbar">
        <div class="row">
          <button class="btn primary" id="btnSavePolicy" type="button">Save policy + audit</button>
          <button class="btn" id="btnResetPolicy" type="button">Reset to defaults</button>
        </div>
        <a class="btn ghost" href="#/queue">Back to queue</a>
      </div>

      <div class="note">
        <strong>Tip:</strong> After saving, return to the queue and open an application to see the
        computed outcome and offer math update under the new policy.
      </div>
    `;

    viewEl.querySelector("#btnSavePolicy").addEventListener("click", () => {
      const minScore = Number(viewEl.querySelector("#minScore").value || DEFAULT_POLICY.minScore);
      const maxTicket = Number(viewEl.querySelector("#maxTicket").value || DEFAULT_POLICY.maxTicket);

      const cap1max = Number(viewEl.querySelector("#cap1max").value || DEFAULT_POLICY.termCaps[0].max);
      const cap1term = Number(viewEl.querySelector("#cap1term").value || DEFAULT_POLICY.termCaps[0].term);

      const cap2max = Number(viewEl.querySelector("#cap2max").value || DEFAULT_POLICY.termCaps[1].max);
      const cap2term = Number(viewEl.querySelector("#cap2term").value || DEFAULT_POLICY.termCaps[1].term);

      const cap3term = Number(viewEl.querySelector("#cap3term").value || DEFAULT_POLICY.termCaps[2].term);

      const residualPct = Number(viewEl.querySelector("#residualPct").value || DEFAULT_POLICY.residualPct);
      const residualFloor = Number(viewEl.querySelector("#residualFloor").value || DEFAULT_POLICY.residualFloor);
      const moneyFactor = Number(viewEl.querySelector("#moneyFactor").value || DEFAULT_POLICY.moneyFactor);

      policy = {
        minScore: clamp(minScore, 300, 850),
        maxTicket: clamp(maxTicket, 500, 50000),
        termCaps: [
          { max: Math.max(1, cap1max), term: Math.max(1, cap1term) },
          { max: Math.max(1, cap2max), term: Math.max(1, cap2term) },
          { max: 999999, term: Math.max(1, cap3term) }
        ],
        residualPct: clamp(residualPct, 0, 1),
        residualFloor: Math.max(0, residualFloor),
        moneyFactor: clamp(moneyFactor, 0, 0.02),
        updatedAt: nowISO()
      };

      saveJSON(KEY_POLICY, policy);
      auditAppend(mkEvent("policy.updated", `Policy updated: minScore=${policy.minScore}, maxTicket=${policy.maxTicket}, caps=[${policy.termCaps.map(c=>`<=${c.max}:${c.term}`).join(", ")}], residualPct=${policy.residualPct}, moneyFactor=${policy.moneyFactor}.`));
      renderPolicy();
    });

    viewEl.querySelector("#btnResetPolicy").addEventListener("click", () => {
      policy = structuredClone(DEFAULT_POLICY);
      policy.updatedAt = nowISO();
      saveJSON(KEY_POLICY, policy);
      auditAppend(mkEvent("policy.reset", "Policy reset to defaults."));
      renderPolicy();
    });
  }

  function renderAudit(){
    setActiveNav();
    const log = loadJSON(KEY_AUDIT, []);
    const rows = log.map(ev => `
      <tr>
        <td class="mono">${escapeHtml(ev.ts)}</td>
        <td class="mono">${escapeHtml(ev.type)}</td>
        <td class="mono">${escapeHtml(ev.actor)}</td>
        <td>${escapeHtml(ev.details)}</td>
      </tr>
    `).join("");

    viewEl.innerHTML = `
      <h2 style="margin:0 0 8px; font-family:var(--serif);">Audit log</h2>
      <p class="sub" style="margin-top:0;">
        Append-only event feed (stored locally in your browser). Demonstrates audit visibility for diligence.
      </p>

      <div class="toolbar">
        <div class="row">
          <span class="badge">${mono(String(log.length))} events</span>
          <span class="badge">Actor ${mono("admin.demo@flintlockfinancing.com")}</span>
        </div>
        <div class="row">
          <button class="btn" id="btnExport" type="button">Export JSON</button>
          <button class="btn ghost" id="btnAddEvent" type="button">Add test event</button>
        </div>
      </div>

      <div class="hr"></div>

      <div style="overflow:auto; border:1px solid rgba(255,255,255,0.10); border-radius:14px;">
        <table>
          <thead>
            <tr>
              <th style="min-width:210px;">Timestamp</th>
              <th style="min-width:160px;">Event</th>
              <th style="min-width:220px;">Actor</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>${rows || ""}</tbody>
        </table>
      </div>

      <div class="note">
        <strong>Demo note:</strong> In Phase 2, this becomes DB-backed with immutable-ish event logging and role-based permissions.
      </div>
    `;

    viewEl.querySelector("#btnAddEvent").addEventListener("click", () => {
      auditAppend(mkEvent("test.event", "Added a synthetic test event from audit screen."));
      renderAudit();
    });

    viewEl.querySelector("#btnExport").addEventListener("click", () => {
      const data = JSON.stringify(log, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "flintlock-audit-log-demo.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  }

  function renderAbout(){
    setActiveNav();
    viewEl.innerHTML = `
      <h2 style="margin:0 0 8px; font-family:var(--serif);">About this demo</h2>
      <p class="sub" style="margin-top:0;">
        This admin console is a storyboard of controls and governance: policy configuration, decision workflow, and auditability.
      </p>

      <div class="hr"></div>

      <div class="note">
        <strong>What’s real here:</strong><br/>
        • Policy settings are editable and persist in your browser<br/>
        • Queue and audit log persist locally (localStorage)<br/>
        • Outcomes update dynamically based on current policy
      </div>

      <div class="note">
        <strong>What’s not real (intentionally):</strong><br/>
        • No credit bureau, no bank integrations, no KYC vendor calls<br/>
        • No consumer data is collected or transmitted<br/>
        • No payments or disbursements
      </div>

      <div class="note">
        <strong>Next step (Phase 2):</strong> DB-backed roles, server-side decisioning, and RLS policies (Supabase) for a true sandbox.
      </div>
    `;
  }

  // ---- Top bar actions ----
  document.getElementById("btnSeed").addEventListener("click", () => {
    apps = seededApps();
    saveJSON(KEY_APPS, apps);
    auditAppend(mkEvent("system.reseed", "Reseeded synthetic applications."));
    location.hash = "#/queue";
    render();
  });

  document.getElementById("btnClear").addEventListener("click", () => {
    localStorage.removeItem(KEY_POLICY);
    localStorage.removeItem(KEY_APPS);
    localStorage.removeItem(KEY_AUDIT);
    policy = structuredClone(DEFAULT_POLICY);
    apps = seededApps();
    saveJSON(KEY_POLICY, policy);
    saveJSON(KEY_APPS, apps);
    saveJSON(KEY_AUDIT, []);
    auditAppend(mkEvent("system.cleared", "Cleared local storage and reinitialized demo."));
    location.hash = "#/queue";
    render();
  });

  // ---- Render router ----
  function render(){
    const r = route();
    if(r === "policy") return renderPolicy();
    if(r === "audit")  return renderAudit();
    if(r === "about")  return renderAbout();
    // default queue
    return renderQueue();
  }

  window.addEventListener("hashchange", render);

  // ---- Utilities ----
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  // Init
  if(!location.hash) location.hash = "#/queue";
  render();
  setActiveNav();
})();
</script>
</body>
</html>
