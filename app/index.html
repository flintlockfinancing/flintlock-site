<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flintlock Financing | App Demo</title>
  <meta name="description" content="Flintlock Financing app demo (synthetic). No credit pulls." />
  <style>
    :root{
      --bg0:#050F1B; --bg1:#061424; --bg2:#071726;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.04);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);
      --line: rgba(255,255,255,0.12);
      --accent:#C57B2A; --accent2:#E2A45D;
      --shadow: 0 18px 40px rgba(0,0,0,0.40);
      --radius:18px; --max:1080px;
      --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --focus: rgba(226,164,93,0.45);
      --ok:#86efac; --warn:#ffd166; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(900px 420px at 18% 0%, rgba(197,123,42,0.18), transparent 55%),
        radial-gradient(720px 380px at 92% 8%, rgba(226,164,93,0.12), transparent 55%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 55%, var(--bg0) 100%);
      line-height:1.45;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:var(--max); margin:0 auto; padding:0 18px}
    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(5,16,28,0.62);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap; padding:14px 0}
    .brand{display:flex; align-items:center; gap:10px}
    .mark{
      width:32px; height:32px; border-radius:10px;
      background:
        radial-gradient(10px 10px at 70% 30%, rgba(255,255,255,0.9), transparent 55%),
        radial-gradient(18px 18px at 65% 35%, rgba(226,164,93,0.65), transparent 60%),
        linear-gradient(180deg, rgba(197,123,42,0.95), rgba(197,123,42,0.35));
      box-shadow:0 10px 22px rgba(197,123,42,0.25);
      border:1px solid rgba(255,255,255,0.15);
    }
    .brand-text{display:flex; flex-direction:column; line-height:1.1}
    .brand-text strong{
      font-family:var(--serif);
      letter-spacing:0.08em;
      text-transform:uppercase;
      font-size:12px;
    }
    .brand-text span{font-size:12px; color:rgba(255,255,255,0.55)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex; gap:10px; align-items:center;
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.74);
      font-size:12px; user-select:none;
    }
    .spark{width:8px; height:8px; border-radius:999px; background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(226,164,93,0.95) 35%, rgba(197,123,42,0.5) 65%, transparent 70%); box-shadow:0 0 22px rgba(226,164,93,0.50)}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:10px 13px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      font-size:13px; cursor:pointer; user-select:none; white-space:nowrap;
      transition: transform 0.06s ease, background 0.2s ease, border-color 0.2s ease;
    }
    .btn:hover{background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.20)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(197,123,42,0.55);
      background: linear-gradient(180deg, rgba(197,123,42,0.95), rgba(197,123,42,0.55));
      box-shadow: 0 16px 34px rgba(197,123,42,0.18);
      color:#0b1016; font-weight:900;
    }
    .card{
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin: 18px 0;
    }
    .section{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      border-radius:16px;
      padding:14px;
    }
    h1{font-family:var(--serif); font-size: clamp(22px, 3.2vw, 34px); margin:18px 0 6px}
    h2{font-family:var(--serif); margin:0 0 8px; font-size:20px}
    h3{margin:0 0 8px; font-size:13px; letter-spacing:0.10em; text-transform:uppercase; color:rgba(255,255,255,0.86); font-weight:800}
    .sub{color:var(--muted); font-size:14px; margin:0 0 14px}
    .hr{height:1px; background: rgba(255,255,255,0.08); margin: 12px 0}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .grid3{display:grid; grid-template-columns: repeat(3,1fr); gap:12px}
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:var(--muted2)}
    input, select{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.92);
      outline:none;
      font-size:14px;
    }
    input:focus, select:focus{
      border-color: rgba(226,164,93,0.42);
      box-shadow: 0 0 0 3px var(--focus);
    }
    .mono{font-family:var(--mono)}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.80);
      font-size:12px; user-select:none;
    }
    .badge.ok{border-color: rgba(134,239,172,0.25); background: rgba(134,239,172,0.08)}
    .badge.warn{border-color: rgba(255,209,102,0.25); background: rgba(255,209,102,0.08)}
    .badge.bad{border-color: rgba(255,107,107,0.25); background: rgba(255,107,107,0.08)}
    .note{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.62);
      font-size:12px;
    }
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tab{
      padding:9px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      font-size:13px;
    }
    .tab.active{border-color: rgba(197,123,42,0.40); background: rgba(197,123,42,0.10)}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,0.07)}
    th{color: rgba(255,255,255,0.84); font-weight:800; background: rgba(255,255,255,0.03); position:sticky; top:0; backdrop-filter: blur(6px)}
    .right{text-align:right}
    .table-wrap{overflow:auto; border:1px solid rgba(255,255,255,0.10); border-radius:14px; max-height:340px}
    @media(max-width:980px){ .grid2,.grid3{grid-template-columns:1fr} }
  </style>
</head>

<body>
<header class="topbar">
  <div class="container">
    <div class="topbar-inner">
      <a class="brand" href="/" aria-label="Home">
        <div class="mark"></div>
        <div class="brand-text">
          <strong>Flintlock Financing</strong>
          <span>App demo</span>
        </div>
      </a>

      <div class="row">
        <span class="pill"><span class="spark"></span><span>SYNTHETIC DEMO / NO CREDIT PULLS</span></span>
        <a class="btn" href="/admin/" target="_blank" rel="noopener">Admin console</a>
        <a class="btn primary" href="#/application">Start application</a>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <h1>Consumer leasing demo</h1>
  <p class="sub">Illustrative terms only. Not a quote or contract.</p>
  <section class="card" id="view"></section>
  <div class="note" style="margin-bottom:24px;">
    <strong>Disclaimer:</strong> Synthetic demo. No funding, no payments, no identity verification, no credit pulls.
  </div>
</main>

<script>
(() => {
  const DEFAULT_POLICY = {
    minScore: 620,
    maxTicket: 12000,
    termCaps: [
      { max: 1500, term: 24 },
      { max: 2500, term: 36 },
      { max: Infinity, term: 48 }
    ],
    residualPct: 0.20,
    residualFloor: 200,
    moneyFactor: 0.0030
  };

  const ADMIN_POLICY_KEY = "flintlock_demo_policy_v1";
  const LAST_OFFER_KEY   = "flintlock_demo_last_offer_v1";

  function structuredCloneSafe(o){ return JSON.parse(JSON.stringify(o)); }
  function loadPolicy(){
    try{
      const raw = localStorage.getItem(ADMIN_POLICY_KEY);
      if(!raw) return structuredCloneSafe(DEFAULT_POLICY);
      const p = JSON.parse(raw);
      const termCaps = Array.isArray(p.termCaps) && p.termCaps.length >= 3
        ? [
            { max: 1500, term: Number(p.termCaps[0].term ?? 24) },
            { max: 2500, term: Number(p.termCaps[1].term ?? 36) },
            { max: Infinity, term: Number(p.termCaps[2].term ?? 48) }
          ]
        : structuredCloneSafe(DEFAULT_POLICY.termCaps);
      return {
        minScore: Number(p.minScore ?? DEFAULT_POLICY.minScore),
        maxTicket: Number(p.maxTicket ?? DEFAULT_POLICY.maxTicket),
        termCaps,
        residualPct: Number(p.residualPct ?? DEFAULT_POLICY.residualPct),
        residualFloor: Number(p.residualFloor ?? DEFAULT_POLICY.residualFloor),
        moneyFactor: Number(p.moneyFactor ?? DEFAULT_POLICY.moneyFactor)
      };
    }catch(e){ return structuredCloneSafe(DEFAULT_POLICY); }
  }

  function saveLastOffer(offer){ try{ localStorage.setItem(LAST_OFFER_KEY, JSON.stringify(offer)); }catch(e){} }
  function loadLastOffer(){ try{ const raw = localStorage.getItem(LAST_OFFER_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; } }

  const PERSONAS = [
    { id:"prime", name:"Prime Applicant", score:720, flags:{ fraud:false, idMismatch:false }, blurb:"Typical approval path." },
    { id:"near",  name:"Near Prime Applicant", score:640, flags:{ fraud:false, idMismatch:false }, blurb:"Closer to policy minimum." },
    { id:"fraud", name:"Fraud Flag", score:700, flags:{ fraud:true, idMismatch:false }, blurb:"Routes to manual review (demo)." },
    { id:"idm",   name:"Identity Mismatch", score:700, flags:{ fraud:false, idMismatch:true }, blurb:"Declines due to identity mismatch (demo)." },
    { id:"below", name:"Below Minimum Score", score:590, flags:{ fraud:false, idMismatch:false }, blurb:"Declines due to policy minimum score." }
  ];

  const state = {
    personaId: "prime",
    applicant: { name:"Alex Morgan", email:"alex.morgan@example.com", phone:"(555) 555-1212", address1:"100 Market St", city:"Houston", state:"TX", postal:"77002" },
    purchase: { itemDescription:"Illustrative Merchant Item", price:4500, acquisitionFee:0, tax:0, processingFee:0 },
    decision: null,
    ui: { buyoutMonth: 12 }
  };

  const viewEl = document.getElementById("view");
  const fmtUSD = (n) => new Intl.NumberFormat("en-US", { style:"currency", currency:"USD" }).format(Number(n||0));
  const escapeHtml = (s) => String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const mono = (s) => `<span class="mono">${escapeHtml(s)}</span>`;
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
  const round2 = (n)=>Math.round(Number(n||0)*100)/100;

  function approxAPRFromMF(mf){ return round2(Number(mf||0)*2400); }
  function route(){
    const h = location.hash || "#/dashboard";
    if(h.startsWith("#/application")) return "application";
    if(h.startsWith("#/offer")) return "offer";
    if(h.startsWith("#/contract")) return "contract";
    return "dashboard";
  }
  function renderTabs(active){
    return `
      <div class="tabs">
        <a class="tab ${active==="application"?"active":""}" href="#/application">Application</a>
        <a class="tab ${active==="offer"?"active":""}" href="#/offer">Offer</a>
        <a class="tab ${active==="dashboard"?"active":""}" href="#/dashboard">Dashboard</a>
        <a class="tab ${active==="contract"?"active":""}" href="#/contract">Contract</a>
      </div>
    `;
  }
  function activePersona(){ return PERSONAS.find(p=>p.id===state.personaId)||PERSONAS[0]; }
  function computeTerm(ticket, policy){
    for(const cap of policy.termCaps){ if(ticket<=cap.max) return cap.term; }
    return policy.termCaps[policy.termCaps.length-1].term;
  }
  function computeResidual(costBasis, policy){
    const r = costBasis * policy.residualPct;
    return Math.max(policy.residualFloor, Math.round(r));
  }
  function computePayment(costBasis, residual, term, policy){
    const dep = (costBasis - residual)/term;
    const rent = (costBasis + residual)*policy.moneyFactor;
    return round2(dep + rent);
  }
  function buyoutAtMonth(costBasis, residual, term, monthElapsed){
    const m = clamp(Number(monthElapsed||0), 0, term);
    return residual + (costBasis - residual) * ((term - m)/term);
  }
  function costBasis(){
    const p=state.purchase;
    return Number(p.price||0)+Number(p.acquisitionFee||0)+Number(p.tax||0)+Number(p.processingFee||0);
  }
  function badgeForOutcome(outcome){
    if(outcome==="APPROVE") return {cls:"ok", text:"Approved"};
    if(outcome==="MANUAL_REVIEW") return {cls:"warn", text:"Manual review"};
    return {cls:"bad", text:"Declined"};
  }

  function evaluate(){
    const policy = loadPolicy();
    const persona = activePersona();

    const ticket = Number(state.purchase.price||0);
    const acquisitionFee = Number(state.purchase.acquisitionFee||0);
    const tax = Number(state.purchase.tax||0);
    const processingFee = Number(state.purchase.processingFee||0);
    const basis = ticket+acquisitionFee+tax+processingFee;

    const reasons=[];
    if(ticket<=0) reasons.push("Invalid item price.");
    if(ticket>policy.maxTicket) reasons.push(`Item price exceeds policy maximum (${fmtUSD(policy.maxTicket)}).`);
    if(persona.score<policy.minScore) reasons.push(`Score below policy minimum (${policy.minScore}).`);

    let outcome="APPROVE";
    let summary="Approved per current policy.";

    if(persona.flags.idMismatch){
      outcome="DECLINE";
      summary="Declined due to identity mismatch (demo).";
      reasons.unshift("Identity verification mismatch (demo).");
    } else if(persona.flags.fraud){
      outcome="MANUAL_REVIEW";
      summary="Routed to manual review due to fraud indicator (demo).";
    } else if(reasons.length){
      outcome="DECLINE";
      summary="Declined due to policy constraints.";
    }

    const term = computeTerm(ticket, policy);
    const residual = computeResidual(basis, policy);
    const payment = computePayment(basis, residual, term, policy);
    const totalOfPayments = round2(payment*term);

    const d = {
      outcome, summary, reasons,
      personaId: persona.id, personaName: persona.name, score: persona.score, flags: persona.flags,
      itemDescription: state.purchase.itemDescription,
      applicant: JSON.parse(JSON.stringify(state.applicant)),
      ticket, acquisitionFee, tax, processingFee,
      costBasis: basis, term, residual, payment, totalOfPayments,
      moneyFactor: policy.moneyFactor,
      approxAprPct: approxAPRFromMF(policy.moneyFactor),
      evaluatedAt: new Date().toISOString()
    };
    state.decision = d;
    saveLastOffer(d);
    return d;
  }

  function toCSV(rows){
    const esc=(v)=>{
      const s=String(v??"");
      if(s.includes('"')||s.includes(",")||s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
      return s;
    };
    return rows.map(r=>r.map(esc).join(",")).join("\n");
  }
  function downloadTextFile(filename, text, mime){
    const blob=new Blob([text],{type:mime||"text/plain"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function buildBuyoutRows(d){
    const rows=[["month_elapsed","buyout_amount","percent_of_basis"]];
    for(let m=0;m<=d.term;m++){
      const buy=round2(buyoutAtMonth(d.costBasis,d.residual,d.term,m));
      const pct=d.costBasis>0?round2((buy/d.costBasis)*100):0;
      rows.push([m,buy,pct]);
    }
    return rows;
  }
  function buildPaymentRows(d){
    const rows=[["payment_number","amount_due","due_frequency","notes"]];
    for(let i=1;i<=d.term;i++) rows.push([i,round2(d.payment),"monthly","Illustrative demo payment schedule"]);
    return rows;
  }
  function renderBuyoutTable(d){
    let body="";
    for(let m=0;m<=d.term;m++){
      const buy=round2(buyoutAtMonth(d.costBasis,d.residual,d.term,m));
      const pct=d.costBasis>0?round2((buy/d.costBasis)*100):0;
      body+=`<tr><td class="mono">${m}</td><td class="right mono">${escapeHtml(fmtUSD(buy))}</td><td class="right mono">${escapeHtml(String(pct))}%</td></tr>`;
    }
    return `<div class="table-wrap"><table><thead><tr><th>Month elapsed</th><th class="right">Straight-line buyout</th><th class="right">% of basis</th></tr></thead><tbody>${body}</tbody></table></div>`;
  }
  function renderPaymentTable(d){
    let body="";
    for(let i=1;i<=d.term;i++){
      body+=`<tr><td class="mono">${i}</td><td class="right mono">${escapeHtml(fmtUSD(d.payment))}</td><td class="mono">Monthly</td></tr>`;
    }
    return `<div class="table-wrap"><table><thead><tr><th>Pmt #</th><th class="right">Amount</th><th>Frequency</th></tr></thead><tbody>${body}</tbody></table></div>`;
  }

  function renderDashboard(){
    const d = state.decision || evaluate();
    const b = badgeForOutcome(d.outcome);
    const month = clamp(Number(state.ui.buyoutMonth||12),0,d.term);
    const buyout = round2(buyoutAtMonth(d.costBasis,d.residual,d.term,month));

    viewEl.innerHTML = `
      <div class="section">
        <h2 style="margin:0 0 6px;">Demo status</h2>
        <p class="sub" style="margin:0 0 10px;">Snapshot of scenario, policy values, and illustrative terms.</p>
        <div class="row">
          <span class="badge ${b.cls}">${b.text}</span>
          <span class="badge">Persona ${mono(d.personaName)}</span>
          <span class="badge">Score ${mono(String(d.score))}</span>
          <span class="badge">MF ${mono(String(d.moneyFactor))} (~${mono(String(d.approxAprPct))}% APR eq)</span>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div class="card">
          <h3>Policy</h3>
          <div class="grid2">
            <div class="field"><label>Minimum score</label><div class="mono">${escapeHtml(String(loadPolicy().minScore))}</div></div>
            <div class="field"><label>Max ticket</label><div class="mono">${escapeHtml(fmtUSD(loadPolicy().maxTicket))}</div></div>
            <div class="field"><label>Term caps</label><div class="mono">${escapeHtml(loadPolicy().termCaps.map(c => (c.max===Infinity ? "else" : "<="+c.max)+":"+c.term).join(", "))}</div></div>
            <div class="field"><label>Residual policy</label><div class="mono">${escapeHtml(String(Math.round(loadPolicy().residualPct*100)))}% (floor ${escapeHtml(fmtUSD(loadPolicy().residualFloor))})</div></div>
          </div>
          <div class="note"><strong>Note:</strong> Policy is controlled in /admin (demo).</div>
        </div>

        <div class="card">
          <h3>Transaction</h3>
          <div class="grid2">
            <div class="field"><label>Ticket (item price)</label><div class="mono">${escapeHtml(fmtUSD(d.ticket))}</div></div>
            <div class="field"><label>Term</label><div class="mono">${escapeHtml(String(d.term))} months</div></div>
            <div class="field"><label>Cost basis</label><div class="mono">${escapeHtml(fmtUSD(d.costBasis))}</div></div>
            <div class="field"><label>Residual (purchase option)</label><div class="mono">${escapeHtml(fmtUSD(d.residual))}</div></div>
          </div>

          <div class="hr"></div>

          <div class="grid3">
            <div class="field"><label>Monthly payment (illustrative)</label><div class="mono" style="font-size:16px;">${escapeHtml(fmtUSD(d.payment))}</div></div>
            <div class="field"><label>Total of payments (illustrative)</label><div class="mono" style="font-size:16px;">${escapeHtml(fmtUSD(d.totalOfPayments))}</div></div>
            <div class="field"><label>Evaluated at</label><div class="mono">${escapeHtml(d.evaluatedAt)}</div></div>
          </div>

          <div class="note">
            <strong>Pricing note:</strong> Payment is storyboard math: straight-line depreciation plus an illustrative rent charge (money factor).
          </div>
        </div>
      </div>

      ${renderTabs("dashboard")}

      <div class="hr"></div>

      <div class="card">
        <h2 style="margin:0 0 8px;">Early purchase option (illustrative)</h2>
        <p class="sub" style="margin:0 0 10px;">Straight-line from full cost basis down to residual over the term.</p>

        <div class="grid2">
          <div class="field">
            <label>Month elapsed</label>
            <input id="buyoutMonth" type="number" min="0" max="${d.term}" step="1" value="${month}" />
          </div>
          <div class="field">
            <label>Early purchase amount at month ${month}</label>
            <input value="${fmtUSD(buyout)}" disabled />
          </div>
        </div>

        <div class="note">
          <strong>Cost basis components:</strong>
          Ticket ${mono(fmtUSD(d.ticket))} • Acquisition fee ${mono(fmtUSD(d.acquisitionFee))} • Tax ${mono(fmtUSD(d.tax))} • Processing ${mono(fmtUSD(d.processingFee))}
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn" id="btnCSVBuyout">Download buyout schedule (CSV)</button>
          <button class="btn" id="btnCSVPayments">Download payment schedule (CSV)</button>
          <button class="btn" id="btnJSON">Download offer snapshot (JSON)</button>
          <a class="btn primary" href="#/contract">Preview contract</a>
          <button class="btn" id="btnReset">Reset</button>
        </div>

        <div class="hr"></div>

        <h2 style="margin:0 0 8px;">Buyout schedule</h2>
        ${renderBuyoutTable(d)}

        <div class="hr"></div>

        <h2 style="margin:0 0 8px;">Payment schedule</h2>
        ${renderPaymentTable(d)}
      </div>
    `;

    document.getElementById("buyoutMonth").addEventListener("input", (e) => {
      state.ui.buyoutMonth = Number(e.target.value||0);
      updateUI();
    });

    document.getElementById("btnReset").addEventListener("click", () => {
      state.personaId="prime";
      state.purchase.price=4500; state.purchase.acquisitionFee=0; state.purchase.tax=0; state.purchase.processingFee=0;
      state.decision=null; state.ui.buyoutMonth=12;
      location.hash="#/dashboard"; updateUI();
    });

    document.getElementById("btnCSVBuyout").addEventListener("click", () => {
      const rows = buildBuyoutRows(d);
      downloadTextFile(`flintlock_buyout_schedule_${d.personaId}_${d.term}mo.csv`, toCSV(rows), "text/csv");
    });

    document.getElementById("btnCSVPayments").addEventListener("click", () => {
      const rows = buildPaymentRows(d);
      downloadTextFile(`flintlock_payment_schedule_${d.personaId}_${d.term}mo.csv`, toCSV(rows), "text/csv");
    });

    document.getElementById("btnJSON").addEventListener("click", () => {
      const payload = {
        demo:true,
        generatedAt:new Date().toISOString(),
        policy: loadPolicy(),
        decision: d,
        buyoutSchedule: buildBuyoutRows(d).slice(1).map(r => ({monthElapsed:r[0], buyoutAmount:r[1], percentOfBasis:r[2]})),
        paymentSchedule: buildPaymentRows(d).slice(1).map(r => ({paymentNumber:r[0], amountDue:r[1], frequency:r[2], notes:r[3]}))
      };
      downloadTextFile(`flintlock_offer_snapshot_${d.personaId}_${d.term}mo.json`, JSON.stringify(payload,null,2), "application/json");
    });
  }

  function renderOffer(){
    const d = state.decision || evaluate();
    const b = badgeForOutcome(d.outcome);
    viewEl.innerHTML = `
      <div class="section">
        <h2 style="margin:0 0 6px;">Offer & disclosures (illustrative)</h2>
        <p class="sub" style="margin:0;">Demonstration only. Not a quote or contract.</p>
      </div>

      <div class="hr"></div>

      <div class="row">
        <span class="badge ${b.cls}">${b.text}</span>
        <span class="badge">Term ${mono(String(d.term))} mo</span>
        <span class="badge">Payment ${mono(fmtUSD(d.payment))}</span>
        <span class="badge">Residual ${mono(fmtUSD(d.residual))}</span>
        <span class="badge">MF ${mono(String(d.moneyFactor))} (~${mono(String(d.approxAprPct))}% APR eq)</span>
      </div>

      <div class="hr"></div>

      <div class="card">
        <h3>Capitalized cost (cost basis)</h3>
        <div class="table-wrap" style="max-height:none;">
          <table>
            <thead><tr><th>Component</th><th class="right">Amount</th></tr></thead>
            <tbody>
              <tr><td>Ticket (item price)</td><td class="right mono">${escapeHtml(fmtUSD(d.ticket))}</td></tr>
              <tr><td>Acquisition fee (capitalized)</td><td class="right mono">${escapeHtml(fmtUSD(d.acquisitionFee))}</td></tr>
              <tr><td>Sales tax (capitalized)</td><td class="right mono">${escapeHtml(fmtUSD(d.tax))}</td></tr>
              <tr><td>Processing fee (capitalized)</td><td class="right mono">${escapeHtml(fmtUSD(d.processingFee))}</td></tr>
              <tr><th>Total cost basis</th><th class="right mono">${escapeHtml(fmtUSD(d.costBasis))}</th></tr>
            </tbody>
          </table>
        </div>

        <div class="hr"></div>

        <h3>Illustrative lease terms</h3>
        <div class="grid3">
          <div class="field"><label>Monthly payment</label><input value="${fmtUSD(d.payment)}" disabled /></div>
          <div class="field"><label>Total of payments</label><input value="${fmtUSD(d.totalOfPayments)}" disabled /></div>
          <div class="field"><label>Purchase option (residual)</label><input value="${fmtUSD(d.residual)}" disabled /></div>
        </div>

        <div class="note">
          <strong>Disclosure language (demo):</strong>
          Acquisition fee is capitalized into the cost basis. Early purchase option is illustrated as straight-line to residual over term.
        </div>

        <div class="row" style="margin-top:12px;">
          <a class="btn" href="#/application">Back</a>
          <a class="btn" href="#/dashboard">Dashboard</a>
          <a class="btn primary" href="#/contract">Preview contract</a>
        </div>
      </div>

      ${renderTabs("offer")}
    `;
  }

  function renderContract(){
    const d = loadLastOffer() || state.decision || evaluate();
    const policy = loadPolicy();
    const contractId = `FF-DEMO-${(d.evaluatedAt || new Date().toISOString()).replaceAll(/[^0-9]/g,"").slice(0,14)}`;
    const today = new Date().toISOString().slice(0,10);
    const aprEq = approxAPRFromMF(Number(d.moneyFactor || policy.moneyFactor || 0));

    viewEl.innerHTML = `
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <h2 style="margin:0 0 6px;">Contract preview (demo)</h2>
            <p class="sub" style="margin:0;">Not legal advice. Not binding.</p>
          </div>
          <div class="row">
            <button class="btn" id="btnPrint">Print / Save as PDF</button>
            <a class="btn" href="#/offer">Back to offer</a>
          </div>
        </div>

        <div class="note">
          <strong>Important:</strong> Demo artifact for testing only.
        </div>

        <div class="hr"></div>

        <div style="background: rgba(255,255,255,0.96); color: rgba(0,0,0,0.88); border-radius: 14px; padding: 18px; border: 1px solid rgba(0,0,0,0.10);">
          <h2 style="margin:0 0 8px; font-family: ui-serif, Georgia, 'Times New Roman', Times, serif;">Flintlock Financing — Consumer Lease Agreement (Demo Preview)</h2>
          <p style="margin: 8px 0; font-size: 12.5px;">
            <span class="mono" style="background: rgba(0,0,0,0.06); padding: 2px 6px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.10);">Contract ID</span>
            ${escapeHtml(contractId)}
            &nbsp;•&nbsp;
            <span class="mono" style="background: rgba(0,0,0,0.06); padding: 2px 6px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.10);">Date</span>
            ${escapeHtml(today)}
            &nbsp;•&nbsp;
            <span class="mono" style="background: rgba(0,0,0,0.06); padding: 2px 6px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.10);">Environment</span>
            SYNTHETIC DEMO
          </p>

          <h3 style="margin: 14px 0 8px; font-family: ui-serif, Georgia, 'Times New Roman', Times, serif;">1. Parties</h3>
          <p style="margin: 8px 0; font-size: 12.5px;">Lessor: Flintlock Financing. Lessee: ${escapeHtml(d.applicant?.name || "Applicant Name")}.</p>

          <h3 style="margin: 14px 0 8px; font-family: ui-serif, Georgia, 'Times New Roman', Times, serif;">2. Leased Property</h3>
          <p style="margin: 8px 0; font-size: 12.5px;">Description: ${escapeHtml(d.itemDescription || "Item")}.</p>

          <h3 style="margin: 14px 0 8px; font-family: ui-serif, Georgia, 'Times New Roman', Times, serif;">3. Capitalized Cost (Cost Basis)</h3>
          <p style="margin: 8px 0; font-size: 12.5px;">
            Ticket ${escapeHtml(fmtUSD(d.ticket))} • Acquisition fee ${escapeHtml(fmtUSD(d.acquisitionFee))} • Tax ${escapeHtml(fmtUSD(d.tax))} • Processing ${escapeHtml(fmtUSD(d.processingFee))}
            <br/><strong>Total cost basis:</strong> ${escapeHtml(fmtUSD(d.costBasis))}
          </p>

          <h3 style="margin: 14px 0 8px; font-family: ui-serif, Georgia, 'Times New Roman', Times, serif;">4. Term and Payments (Illustrative)</h3>
          <p style="margin: 8px 0; font-size: 12.5px;">
            Term: ${escapeHtml(String(d.term))} months • Monthly payment: ${escapeHtml(fmtUSD(d.payment))} • Total of payments: ${escapeHtml(fmtUSD(d.totalOfPayments))}
            <br/>Money factor: ${escapeHtml(String(d.moneyFactor))} (≈ ${escapeHtml(String(aprEq))}% APR eq; demo only)
          </p>

          <h3 style="margin: 14px 0 8px; font-family: ui-serif, Georgia, 'Times New Roman', Times, serif;">5. Purchase Option (Residual)</h3>
          <p style="margin: 8px 0; font-size: 12.5px;">End-of-term purchase option (illustrative): ${escapeHtml(fmtUSD(d.residual))}.</p>

          <h3 style="margin: 14px 0 8px; font-family: ui-serif, Georgia, 'Times New Roman', Times, serif;">6. Early Purchase Option (Illustrative)</h3>
          <p style="margin: 8px 0; font-size: 12.5px;">Straight-line from cost basis down to residual over the term (illustrative).</p>

          <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.15); font-size: 11px; color: rgba(0,0,0,0.60);">
            Demo artifact. Not legal advice. Contract ID ${escapeHtml(contractId)}.
          </div>
        </div>

        ${renderTabs("contract")}
      </div>
    `;

    document.getElementById("btnPrint").addEventListener("click", () => window.print());
  }

  function renderApplication(){
    const policy = loadPolicy();
    const persona = activePersona();

    viewEl.innerHTML = `
      <div class="section">
        <h2 style="margin:0 0 6px;">Application (synthetic)</h2>
        <p class="sub" style="margin:0;">Inputs are synthetic. No credit pull.</p>
      </div>

      <div class="hr"></div>

      <div class="card">
        <h3>Persona selector</h3>
        <div class="grid2">
          <div class="field">
            <label>Persona</label>
            <select id="persona">
              ${PERSONAS.map(p=>`
                <option value="${escapeHtml(p.id)}" ${p.id===state.personaId?"selected":""}>
                  ${escapeHtml(p.name)} (score ${p.score}${p.flags.fraud?", fraud":""}${p.flags.idMismatch?", id mismatch":""})
                </option>
              `).join("")}
            </select>
          </div>
          <div class="field">
            <label>Persona description</label>
            <input value="${escapeHtml(persona.blurb)}" disabled />
          </div>
        </div>

        <div class="hr"></div>

        <h3>Item / transaction</h3>
        <div class="grid2">
          <div class="field"><label>Item description</label><input id="itemDescription" value="${escapeHtml(state.purchase.itemDescription)}"/></div>
          <div class="field"><label>Item price (ticket) (max ${fmtUSD(policy.maxTicket)})</label><input id="price" type="number" min="1" max="${policy.maxTicket}" step="1" value="${Number(state.purchase.price||0)}"/></div>
          <div class="field"><label>Acquisition fee (capitalized)</label><input id="acq" type="number" min="0" step="1" value="${Number(state.purchase.acquisitionFee||0)}"/></div>
          <div class="field"><label>Sales tax (capitalized)</label><input id="tax" type="number" min="0" step="1" value="${Number(state.purchase.tax||0)}"/></div>
          <div class="field"><label>Processing fee (capitalized)</label><input id="proc" type="number" min="0" step="1" value="${Number(state.purchase.processingFee||0)}"/></div>
          <div class="field"><label>Total cost basis</label><input id="basis" value="${fmtUSD(costBasis())}" disabled/></div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="btnSubmit">Submit (demo)</button>
          <a class="btn" href="#/dashboard">Dashboard</a>
        </div>
      </div>

      ${renderTabs("application")}
    `;

    const updateBasis = () => { const el=document.getElementById("basis"); if(el) el.value = fmtUSD(costBasis()); };

    document.getElementById("persona").addEventListener("change",(e)=>{ state.personaId=e.target.value; state.decision=null; updateUI(); });
    document.getElementById("itemDescription").addEventListener("input",(e)=>{ state.purchase.itemDescription=e.target.value; state.decision=null; });
    document.getElementById("price").addEventListener("input",(e)=>{ state.purchase.price=Number(e.target.value||0); state.decision=null; updateBasis(); });
    document.getElementById("acq").addEventListener("input",(e)=>{ state.purchase.acquisitionFee=Number(e.target.value||0); state.decision=null; updateBasis(); });
    document.getElementById("tax").addEventListener("input",(e)=>{ state.purchase.tax=Number(e.target.value||0); state.decision=null; updateBasis(); });
    document.getElementById("proc").addEventListener("input",(e)=>{ state.purchase.processingFee=Number(e.target.value||0); state.decision=null; updateBasis(); });

    document.getElementById("btnSubmit").addEventListener("click",()=>{ const d=evaluate(); location.hash = (d.outcome==="APPROVE") ? "#/offer" : "#/dashboard"; updateUI(); });
  }

  function renderAll(){
    const r=route();
    if(r==="application") return renderApplication();
    if(r==="offer") return renderOffer();
    if(r==="contract") return renderContract();
    return renderDashboard();
  }

  function updateUI(){ renderAll(); }
  window.addEventListener("hashchange", updateUI);
  if(!location.hash) location.hash="#/dashboard";
  updateUI();
})();
</script>
</body>
</html>
