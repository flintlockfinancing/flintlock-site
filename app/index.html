<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flintlock Financing — App Demo</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{
      --bg0:#06111f;
      --bg1:#071a2b;
      --card:#0b2136;
      --card2:#0a1d30;
      --line: rgba(255,255,255,.10);
      --line2: rgba(255,255,255,.14);
      --text:#eaf2ff;
      --muted: rgba(234,242,255,.72);
      --muted2: rgba(234,242,255,.55);
      --gold:#b8792a;
      --gold2:#d7a35a;
      --btn:#0d2a45;
      --btn2:#0b2238;
      --ok:#1fbf75;
      --bad:#ff5f6d;
      --warn:#ffcc66;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    html,body{height:100%;}
    body{
      margin:0;
      color:var(--text);
      font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(184,121,42,.14), transparent 55%),
        radial-gradient(900px 600px at 85% 18%, rgba(140,200,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    a{color:inherit}
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(7,20,35,.78);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbar .inner{
      max-width:1100px; margin:0 auto;
      display:flex; align-items:center; gap:14px;
      padding:14px 16px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      text-decoration:none;
      min-width: 240px;
    }
    .mark{
      width:36px; height:36px; border-radius:10px;
      background: radial-gradient(circle at 30% 30%, rgba(215,163,90,.85), rgba(184,121,42,.35));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 25px rgba(0,0,0,.28);
    }
    .brand .t1{font-weight:800; letter-spacing:.08em; font-size:12px; text-transform:uppercase; line-height:1;}
    .brand .t2{font-size:12px; color:var(--muted); line-height:1.25; margin-top:3px;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border: 1px solid var(--line);
      background: rgba(10,30,50,.40);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:7px;height:7px;border-radius:99px;background:var(--gold2); box-shadow:0 0 0 3px rgba(215,163,90,.15);}
    .nav{
      margin-left:auto;
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(13,42,69,.9), rgba(10,30,50,.7));
      color: var(--text);
      text-decoration:none;
      font-weight:650;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{border-color: rgba(255,255,255,.18);}
    .btn.primary{
      border-color: rgba(215,163,90,.55);
      background: linear-gradient(180deg, rgba(184,121,42,.95), rgba(120,75,18,.92));
      color: #0b0f14;
      font-weight:800;
    }
    .btn.ghost{
      background: rgba(10,30,50,.35);
      color: var(--text);
    }
    .btn.small{padding:8px 10px; font-size:12px; border-radius:11px;}
    .container{max-width:1100px; margin:0 auto; padding:26px 16px 60px;}
    h1{
      font-family: var(--serif);
      font-weight: 800;
      letter-spacing:-.02em;
      font-size: 46px;
      margin: 18px 0 8px;
    }
    .sub{color:var(--muted); margin:0 0 18px; max-width:860px; line-height:1.45}
    .note{
      border:1px solid var(--line);
      background: rgba(10,30,50,.35);
      padding:12px 14px;
      border-radius: 14px;
      color: var(--muted);
      line-height:1.4;
      font-size:13px;
    }
    .hr{height:1px;background:var(--line); margin:18px 0;}
    .card{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(11,33,54,.72), rgba(10,29,48,.52));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:14px;}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;}
    @media (max-width: 900px){ .grid2,.grid3{grid-template-columns:1fr;} h1{font-size:38px;} .brand{min-width:auto;} }

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin:10px 0 0;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(10,30,50,.25);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .tab.active{
      border-color: rgba(215,163,90,.55);
      box-shadow: 0 0 0 4px rgba(215,163,90,.12);
    }

    .field{
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(5,18,31,.35);
      padding:12px;
    }
    .field label{
      display:block;
      color: var(--muted2);
      font-size:12px;
      margin-bottom:6px;
    }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 12px;
      padding:11px 10px;
      outline:none;
      font-size:14px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(215,163,90,.55);
      box-shadow: 0 0 0 4px rgba(215,163,90,.10);
    }
    input[disabled], textarea[disabled]{opacity:.85}
    .mono{font-family:var(--mono);}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .right{margin-left:auto;}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      border-radius: 999px;
      padding:8px 10px;
      border:1px solid var(--line);
      background: rgba(10,30,50,.25);
      font-size:12px;
      font-weight:800;
    }
    .badge.ok{border-color: rgba(31,191,117,.35); color:#d9ffe9;}
    .badge.bad{border-color: rgba(255,95,109,.35); color:#ffe3e6;}
    .kpi{
      border:1px solid var(--line);
      background: rgba(10,30,50,.25);
      border-radius: 14px;
      padding:12px;
      min-height:72px;
    }
    .kpi .k{color:var(--muted2); font-size:12px;}
    .kpi .v{margin-top:6px; font-weight:900; font-size:18px;}
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(5,18,31,.28);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;
      font-size:13px;
      color: var(--text);
    }
    th{color: var(--muted); font-weight:800; font-size:12px; letter-spacing:.04em; text-transform:uppercase;}
    tr:last-child td{border-bottom:none;}
    .pre{
      white-space:pre-wrap;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.45;
      color: #eaf2ff;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
      max-height: 520px;
      overflow:auto;
    }
    .footerNote{
      margin-top:18px;
      color: var(--muted2);
      border: 1px solid var(--line);
      background: rgba(10,30,50,.18);
      padding: 12px 14px;
      border-radius: 14px;
      font-size:12px;
      line-height:1.4;
    }
    .err{
      border-color: rgba(255,95,109,.40) !important;
      background: rgba(255,95,109,.10) !important;
      color: #ffe3e6 !important;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="inner">
      <a class="brand" href="/" aria-label="Flintlock Financing Home">
        <div class="mark" aria-hidden="true"></div>
        <div>
          <div class="t1">FLINTLOCK FINANCING</div>
          <div class="t2">App demo (synthetic)</div>
        </div>
      </a>

      <span class="pill"><span class="dot"></span> SYNTHETIC DEMO / NO CREDIT PULLS</span>

      <nav class="nav" aria-label="Primary navigation">
        <a class="btn ghost" href="/admin" rel="noopener">Admin console</a>
        <a class="btn primary" href="#app" id="startBtn">Start application</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1>Consumer leasing demo</h1>
    <p class="sub">
      Illustrative terms only. Not a quote or contract. This environment is designed for bank/investor storyboarding and integration demos.
    </p>

    <div class="note">
      <strong>Disclaimer:</strong> Synthetic demo. No funding, no payments, no identity verification, and no credit pulls occur here.
      Any personal data shown is synthetic.
    </div>

    <div class="hr"></div>

    <section class="card" id="app">
      <div class="row">
        <div class="badge" id="decisionBadge">Decision: —</div>
        <div class="right row">
          <button class="btn small" id="exportOfferJson">Export offer (JSON)</button>
          <button class="btn small" id="exportBuyoutCsv">Export buyout (CSV)</button>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Demo tabs">
        <button class="tab active" data-tab="application" type="button">Application</button>
        <button class="tab" data-tab="offer" type="button">Offer</button>
        <button class="tab" data-tab="dashboard" type="button">Dashboard</button>
        <button class="tab" data-tab="disclosures" type="button">Disclosures</button>
        <button class="tab" data-tab="contract" type="button">Contract</button>
        <button class="tab" data-tab="exhibitC" type="button">Exhibit C</button>
      </div>

      <div class="hr"></div>

      <div id="view"></div>

      <div class="footerNote">
        <strong>Implementation note:</strong> Policy inputs are read from your browser (<span class="mono">localStorage</span>).
        Use <span class="mono">/admin</span> to update policy, then come back here—this page will pick up changes automatically (no refresh required).
      </div>

      <div class="footerNote">
        <strong>Math note (demo):</strong> Payment uses straight-line depreciation on full cost basis plus an illustrative rent charge using a money factor.
        Buyout uses straight-line from cost basis down to residual.
      </div>

      <div class="footerNote">
        <strong>Compliance note:</strong> Labels and disclosures here are storyboard placeholders.
        Final Reg M and state disclosure language must be counsel-reviewed.
      </div>
    </section>
  </main>

  <script>
    (function(){
      // ---------- Storage keys ----------
      const KEY_POLICY = "flintlock_policy_v1";
      const KEY_APPDATA = "flintlock_appdata_v1";

      // ---------- Defaults ----------
      const defaultPolicy = {
        minScore: 620,
        maxTicket: 12000,
        termCap1500: 24,
        termCap2500: 36,
        termCapOver2500: 48,
        moneyFactor: 0.003,
        residualPercent: 0.20,
        residualFloor: 200
      };

      const defaultApp = {
        persona: "Prime Applicant",
        score: 720,
        ticket: 4500,
        acquisitionFee: 250,
        tax: 360,
        processingFee: 35,
        term: 48,
        buyoutMonth: 12
      };

      // ---------- Helpers ----------
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));

      function safeJsonParse(str, fallback){
        try{
          const v = JSON.parse(str);
          return (v && typeof v === "object") ? v : fallback;
        }catch(e){ return fallback; }
      }

      function clamp(n, lo, hi){
        n = Number(n);
        if (Number.isNaN(n)) return lo;
        return Math.max(lo, Math.min(hi, n));
      }

      function fmtUSD(n){
        const x = Number(n) || 0;
        return x.toLocaleString("en-US", { style:"currency", currency:"USD" });
      }
      function fmtNum(n, d=2){
        const x = Number(n);
        if (Number.isNaN(x)) return "—";
        return x.toFixed(d);
      }

      function downloadText(filename, text){
        const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function downloadCsv(filename, rows){
        const esc = (v) => {
          const s = String(v ?? "");
          if (s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
          return s;
        };
        const csv = rows.map(r => r.map(esc).join(",")).join("\n");
        downloadText(filename, csv);
      }

      function computeCostBasis(d){
        return (Number(d.ticket)||0) + (Number(d.acquisitionFee)||0) + (Number(d.tax)||0) + (Number(d.processingFee)||0);
      }

      function computeResidual(costBasis, policy){
        const pct = Number(policy.residualPercent) || 0;
        const floor = Number(policy.residualFloor) || 0;
        return Math.max(costBasis * pct, floor);
      }

      function computeTermCap(ticket, policy){
        const t = Number(ticket)||0;
        if (t <= 1500) return Number(policy.termCap1500)||24;
        if (t <= 2500) return Number(policy.termCap2500)||36;
        return Number(policy.termCapOver2500)||48;
      }

      function decide(d, policy){
        const flags = [];
        const minScore = Number(policy.minScore)||0;
        const maxTicket = Number(policy.maxTicket)||0;

        if ((Number(d.score)||0) < minScore) flags.push("CREDIT_SCORE_BELOW_MIN");
        if ((Number(d.ticket)||0) > maxTicket) flags.push("TICKET_ABOVE_MAX");

        // Term cap based on ticket
        const cap = computeTermCap(d.ticket, policy);
        const term = clamp(d.term, 1, cap);
        if (Number(d.term) > cap) flags.push("TERM_CAPPED_BY_POLICY");

        const approved = (flags.filter(f => f !== "TERM_CAPPED_BY_POLICY").length === 0);
        return { approved, flags, termCap: cap, term };
      }

      function computePayment(costBasis, residual, term, moneyFactor){
        // Demo-only: straight-line depreciation + money-factor rent charge on (cost + residual) / 2
        term = Math.max(1, Number(term)||1);
        const dep = (costBasis - residual) / term;
        const mf = Number(moneyFactor)||0;
        const avgBase = (costBasis + residual) / 2;
        const rent = avgBase * mf;
        return Math.max(0, dep + rent);
      }

      function buyoutAtMonth(costBasis, residual, term, m){
        term = Math.max(1, Number(term)||1);
        m = clamp(m, 0, term);
        const slope = (costBasis - residual) / term;
        const amt = costBasis - slope * m;
        return Math.max(residual, amt);
      }

      function buildBuyoutSchedule(costBasis, residual, term){
        const rows = [];
        for (let m=0; m<=term; m++){
          rows.push([m, buyoutAtMonth(costBasis, residual, term, m)]);
        }
        return rows;
      }

      // ---------- State ----------
      let policy = loadPolicy();
      let app = loadApp();
      let activeTab = "application";

      function loadPolicy(){
        const v = safeJsonParse(localStorage.getItem(KEY_POLICY), null);
        return Object.assign({}, defaultPolicy, v || {});
      }
      function savePolicy(p){
        localStorage.setItem(KEY_POLICY, JSON.stringify(p));
      }

      function loadApp(){
        const v = safeJsonParse(localStorage.getItem(KEY_APPDATA), null);
        return Object.assign({}, defaultApp, v || {});
      }
      function saveApp(a){
        localStorage.setItem(KEY_APPDATA, JSON.stringify(a));
      }

      // ---------- Rendering ----------
      function setDecisionBadge(decision){
        const el = $("#decisionBadge");
        if (!el) return;
        el.classList.remove("ok","bad");
        if (decision.approved){
          el.textContent = "Approved";
          el.classList.add("ok");
        } else {
          el.textContent = "Declined (demo)";
          el.classList.add("bad");
        }
      }

      function render(){
        // Always re-load policy in case /admin changed it
        policy = loadPolicy();

        // sanitize + recompute derived
        const costBasis = computeCostBasis(app);
        const decision = decide(app, policy);
        app.term = decision.term; // apply cap
        const residual = computeResidual(costBasis, policy);
        const payment = computePayment(costBasis, residual, app.term, policy.moneyFactor);
        const buyout = buyoutAtMonth(costBasis, residual, app.term, app.buyoutMonth);

        setDecisionBadge(decision);

        const view = $("#view");
        if (!view) return;

        // Tab content
        const html = (() => {
          switch(activeTab){
            case "application": return renderApplication(app, policy, decision, costBasis, residual, payment, buyout);
            case "offer": return renderOffer(app, policy, decision, costBasis, residual, payment, buyout);
            case "dashboard": return renderDashboard(app, policy, decision, costBasis, residual, payment, buyout);
            case "disclosures": return renderDisclosures(app, policy, decision, costBasis, residual, payment);
            case "contract": return renderContract(app, policy, decision, costBasis, residual, payment);
            case "exhibitC": return renderExhibitC(app, policy);
            default: return renderApplication(app, policy, decision, costBasis, residual, payment, buyout);
          }
        })();

        view.innerHTML = html;
        wireTabSpecificHandlers(costBasis, residual, payment);
      }

      function renderApplication(d, p, decision, costBasis, residual, payment, buyout){
        return `
          <div class="grid2">
            <div class="field">
              <label>Applicant persona (synthetic)</label>
              <input id="persona" value="${escape(d.persona)}" placeholder="Prime Applicant" />
            </div>
            <div class="field">
              <label>Credit score (synthetic)</label>
              <input id="score" type="number" min="300" max="850" step="1" value="${Number(d.score)||0}" />
            </div>
          </div>

          <div class="hr"></div>

          <div class="grid2">
            <div class="field">
              <label>Ticket (item price)</label>
              <input id="ticket" type="number" min="0" step="1" value="${Number(d.ticket)||0}" />
            </div>
            <div class="field">
              <label>Lease term (months)</label>
              <input id="term" type="number" min="1" step="1" value="${Number(d.term)||0}" />
            </div>
          </div>

          <div class="hr"></div>

          <div class="grid2">
            <div class="field">
              <label>Acquisition fee (capitalized)</label>
              <input id="acquisitionFee" type="number" min="0" step="1" value="${Number(d.acquisitionFee)||0}" />
            </div>
            <div class="field">
              <label>Sales tax (capitalized)</label>
              <input id="tax" type="number" min="0" step="1" value="${Number(d.tax)||0}" />
            </div>
          </div>

          <div class="grid2" style="margin-top:14px;">
            <div class="field">
              <label>Processing (capitalized)</label>
              <input id="processingFee" type="number" min="0" step="1" value="${Number(d.processingFee)||0}" />
            </div>
            <div class="field">
              <label>Cost basis (computed)</label>
              <div class="mono" style="font-size:16px; margin-top:6px;">${fmtUSD(costBasis)}</div>
              <div style="margin-top:6px; color: var(--muted2); font-size:12px;">
                Ticket + acquisition fee + tax + processing
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="grid3">
            <div class="kpi">
              <div class="k">Min score</div>
              <div class="v mono">${Number(p.minScore)||0}</div>
            </div>
            <div class="kpi">
              <div class="k">Term cap (by ticket)</div>
              <div class="v mono">${decision.termCap} mo</div>
            </div>
            <div class="kpi">
              <div class="k">Residual (purchase option)</div>
              <div class="v mono">${fmtUSD(residual)}</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="note">
            <strong>Demo status:</strong>
            ${decision.approved ? `<span class="mono" style="color:#d9ffe9;">APPROVED</span>` : `<span class="mono" style="color:#ffe3e6;">DECLINED</span>`}
            ${decision.flags && decision.flags.length ? `<br/><span class="mono">Flags:</span> ${decision.flags.map(f=>`<span class="mono">${escape(f)}</span>`).join(", ")}` : ``}
          </div>

          <div class="hr"></div>

          <div class="row">
            <button class="btn primary" id="toOffer" type="button">Continue to offer</button>
            <button class="btn" id="resetDemo" type="button">Reset demo inputs</button>
            <span class="right pill"><span class="dot"></span> No credit pulls · no funding · synthetic data</span>
          </div>
        `;
      }

      function renderOffer(d, p, decision, costBasis, residual, payment, buyout){
        const totalPayments = payment * (Number(d.term)||1);
        return `
          <div class="grid3">
            <div class="kpi">
              <div class="k">Ticket</div>
              <div class="v mono">${fmtUSD(d.ticket)}</div>
            </div>
            <div class="kpi">
              <div class="k">Cost basis</div>
              <div class="v mono">${fmtUSD(costBasis)}</div>
            </div>
            <div class="kpi">
              <div class="k">Monthly payment (illustrative)</div>
              <div class="v mono">${fmtUSD(payment)}</div>
            </div>
          </div>

          <div class="grid3" style="margin-top:12px;">
            <div class="kpi">
              <div class="k">Lease term</div>
              <div class="v mono">${Number(d.term)||0} mo</div>
            </div>
            <div class="kpi">
              <div class="k">Total of payments (approx.)</div>
              <div class="v mono">${fmtUSD(totalPayments)}</div>
            </div>
            <div class="kpi">
              <div class="k">Purchase option (residual)</div>
              <div class="v mono">${fmtUSD(residual)}</div>
            </div>
          </div>

          <div class="hr"></div>

          <h2 style="font-family:var(--serif); margin:0 0 6px;">Early buyout (illustrative)</h2>
          <p class="sub" style="margin:0 0 14px;">
            Methodology: <span class="mono">Straight-line buyout</span> from full cost basis down to residual over the term.
          </p>

          <div class="grid2">
            <div class="field">
              <label>Month elapsed</label>
              <input id="buyoutMonth" type="number" min="0" max="${Number(d.term)||1}" step="1" value="${Number(d.buyoutMonth)||0}" />
            </div>
            <div class="field">
              <label>Buyout amount at month ${Number(d.buyoutMonth)||0}</label>
              <input value="${fmtUSD(buyout)}" disabled />
            </div>
          </div>

          <div class="hr"></div>

          <h2 style="font-family:var(--serif); margin:0 0 6px;">Buyout schedule (straight-line)</h2>
          <p class="sub" style="margin:0 0 14px;">
            Straight-line from cost basis to residual over ${Number(d.term)||0} months.
          </p>

          ${renderBuyoutTable(costBasis, residual, Number(d.term)||1)}

          <div class="hr"></div>

          <div class="row">
            <button class="btn" id="backToApp" type="button">Back</button>
            <button class="btn primary" id="toDisclosures" type="button">View disclosures</button>
            <button class="btn" id="toContract" type="button">Preview contract</button>
          </div>

          <div class="note" style="margin-top:14px;">
            <strong>Cost basis components (capitalized):</strong><br/>
            Ticket: <span class="mono">${fmtUSD(d.ticket)}</span> ·
            Acquisition fee: <span class="mono">${fmtUSD(d.acquisitionFee)}</span> ·
            Sales tax: <span class="mono">${fmtUSD(d.tax)}</span> ·
            Processing: <span class="mono">${fmtUSD(d.processingFee)}</span>
          </div>
        `;
      }

      function renderDashboard(d, p, decision, costBasis, residual, payment, buyout){
        return `
          <div class="note">
            <strong>Demo status snapshot:</strong> This panel is designed to mirror what an “audit log / decision snapshot” card could look like.
          </div>

          <div class="hr"></div>

          <div class="grid3">
            <div class="kpi"><div class="k">Decision</div><div class="v mono">${decision.approved ? "APPROVED" : "DECLINED"}</div></div>
            <div class="kpi"><div class="k">Persona</div><div class="v mono">${escape(d.persona)}</div></div>
            <div class="kpi"><div class="k">Score</div><div class="v mono">${Number(d.score)||0}</div></div>
          </div>

          <div class="grid3" style="margin-top:12px;">
            <div class="kpi"><div class="k">Ticket</div><div class="v mono">${fmtUSD(d.ticket)}</div></div>
            <div class="kpi"><div class="k">Term</div><div class="v mono">${Number(d.term)||0} mo</div></div>
            <div class="kpi"><div class="k">Max ticket</div><div class="v mono">${fmtUSD(p.maxTicket)}</div></div>
          </div>

          <div class="grid3" style="margin-top:12px;">
            <div class="kpi"><div class="k">Cost basis</div><div class="v mono">${fmtUSD(costBasis)}</div></div>
            <div class="kpi"><div class="k">Residual</div><div class="v mono">${fmtUSD(residual)}</div></div>
            <div class="kpi"><div class="k">Payment (illustrative)</div><div class="v mono">${fmtUSD(payment)}</div></div>
          </div>

          <div class="hr"></div>

          <div class="note">
            <strong>Flags:</strong> ${decision.flags && decision.flags.length ? decision.flags.map(f=>`<span class="mono">${escape(f)}</span>`).join(", ") : "<span class='mono'>NONE</span>"}
          </div>

          <div class="hr"></div>

          <div class="row">
            <button class="btn" id="dashToOffer" type="button">Go to offer</button>
            <button class="btn primary" id="dashToContract" type="button">Contract</button>
            <button class="btn" id="dashToExhibitC" type="button">Exhibit C</button>
          </div>
        `;
      }

      function renderDisclosures(d, p, decision, costBasis, residual, payment){
        const totalPayments = payment * (Number(d.term)||1);
        return `
          <h2 style="font-family:var(--serif); margin:0 0 6px;">Disclosures (illustrative)</h2>
          <p class="sub" style="margin:0 0 14px;">
            Reg M-style summary box for storyboard purposes only.
          </p>

          <div class="grid2">
            <div class="kpi">
              <div class="k">Lease term</div>
              <div class="v mono">${Number(d.term)||0} months</div>
            </div>
            <div class="kpi">
              <div class="k">Monthly payment (illustrative)</div>
              <div class="v mono">${fmtUSD(payment)}</div>
            </div>
          </div>

          <div class="grid2" style="margin-top:12px;">
            <div class="kpi">
              <div class="k">Total of payments (approx.)</div>
              <div class="v mono">${fmtUSD(totalPayments)}</div>
            </div>
            <div class="kpi">
              <div class="k">Purchase option (residual)</div>
              <div class="v mono">${fmtUSD(residual)}</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="note">
            <strong>Important:</strong> This disclosure panel is a demo approximation and is not a substitute for counsel-reviewed Reg M disclosures.
            Values shown are computed using storyboard math and synthetic inputs.
          </div>

          <div class="hr"></div>

          <h3 style="font-family:var(--serif); margin:0 0 10px;">Cost basis breakdown</h3>

          <div class="grid2">
            <div class="kpi"><div class="k">Ticket</div><div class="v mono">${fmtUSD(d.ticket)}</div></div>
            <div class="kpi"><div class="k">Acquisition fee (capitalized)</div><div class="v mono">${fmtUSD(d.acquisitionFee)}</div></div>
          </div>

          <div class="grid2" style="margin-top:12px;">
            <div class="kpi"><div class="k">Sales tax (capitalized)</div><div class="v mono">${fmtUSD(d.tax)}</div></div>
            <div class="kpi"><div class="k">Processing (capitalized)</div><div class="v mono">${fmtUSD(d.processingFee)}</div></div>
          </div>

          <div class="grid2" style="margin-top:12px;">
            <div class="kpi"><div class="k">Total cost basis</div><div class="v mono">${fmtUSD(costBasis)}</div></div>
            <div class="kpi"><div class="k">Residual (purchase option)</div><div class="v mono">${fmtUSD(residual)}</div></div>
          </div>

          <div class="hr"></div>
          <div class="row">
            <button class="btn" id="discBackOffer" type="button">Back to offer</button>
            <button class="btn primary" id="discContract" type="button">Preview contract</button>
          </div>
        `;
      }

      function renderContract(d, p, decision, costBasis, residual, payment){
        const contract = buildContractText(d, p, decision, costBasis, residual, payment);
        return `
          <h2 style="font-family:var(--serif); margin:0 0 6px;">Contract preview (demo)</h2>
          <p class="sub" style="margin:0 0 14px;">
            Generated example contract text for bank/investor storyboarding and systems integration demos.
          </p>

          <div class="row">
            <button class="btn" id="dlContract" type="button">Download contract (.txt)</button>
            <button class="btn" id="dlExhibitC" type="button">Download Exhibit C (.txt)</button>
            <button class="btn primary" id="contractBackOffer" type="button">Back to offer</button>
          </div>

          <div class="hr"></div>

          <div class="pre" id="contractPre">${escape(contract)}</div>

          <div class="hr"></div>

          <h3 style="font-family:var(--serif); margin:0 0 10px;">Exhibit A — Buyout schedule</h3>
          ${renderBuyoutTable(costBasis, residual, Number(d.term)||1)}

          <div class="hr"></div>

          <h3 style="font-family:var(--serif); margin:0 0 10px;">Exhibit B — Pricing & policy summary</h3>
          <div class="pre">${escape(JSON.stringify(buildSnapshot(d,p,decision,costBasis,residual,payment), null, 2))}</div>

          <div class="note" style="margin-top:12px;">
            This preview is intentionally plain-text for maximum portability and easy parsing in demos.
            You can later format into PDF/Doc with a template engine.
          </div>
        `;
      }

      function renderExhibitC(d, p){
        const t = buildExhibitCText(p);
        return `
          <h2 style="font-family:var(--serif); margin:0 0 6px;">Exhibit C — Credit box summary (one-page)</h2>
          <p class="sub" style="margin:0 0 14px;">
            A concise “credit box” exhibit intended for investor/bank review. Demo-only.
          </p>

          <div class="row">
            <button class="btn" id="dlExhibitC2" type="button">Download Exhibit C (.txt)</button>
            <button class="btn primary" id="exBackOffer" type="button">Back to offer</button>
          </div>

          <div class="hr"></div>
          <div class="pre">${escape(t)}</div>
        `;
      }

      function renderBuyoutTable(costBasis, residual, term){
        const rows = buildBuyoutSchedule(costBasis, residual, term);
        const head = `
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Buyout amount</th>
              </tr>
            </thead>
            <tbody>
        `;
        const body = rows.map(([m, amt]) => `
          <tr>
            <td class="mono">${m}</td>
            <td class="mono">${fmtUSD(amt)}</td>
          </tr>
        `).join("");
        const foot = `</tbody></table>`;
        return head + body + foot;
      }

      function escape(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      // ---------- Documents ----------
      function buildSnapshot(d,p,decision,costBasis,residual,payment){
        return {
          policy: {
            minScore: p.minScore,
            maxTicket: p.maxTicket,
            termCap1500: p.termCap1500,
            termCap2500: p.termCap2500,
            termCapOver2500: p.termCapOver2500,
            moneyFactor: p.moneyFactor,
            residualPercent: p.residualPercent,
            residualFloor: p.residualFloor
          },
          decision: {
            approved: decision.approved,
            flags: decision.flags,
            termCap: decision.termCap,
            term: decision.term
          },
          pricing: {
            ticket: d.ticket,
            acquisitionFee: d.acquisitionFee,
            tax: d.tax,
            processingFee: d.processingFee,
            costBasis,
            residual,
            term: d.term,
            payment: Number(fmtNum(payment,2))
          }
        };
      }

      function buildExhibitCText(p){
        return [
          "EXHIBIT C — CREDIT BOX SUMMARY (DEMO)",
          "",
          "Program Name: Flintlock Financing (Synthetic Demo)",
          "Purpose: Demonstrate policy gating, auditability, and controlled pricing.",
          "",
          "ELIGIBILITY (ILLUSTRATIVE)",
          `- Minimum credit score: ${p.minScore}`,
          `- Maximum ticket (item price): ${fmtUSD(p.maxTicket)}`,
          "",
          "TERM CAPS (ILLUSTRATIVE)",
          `- Ticket ≤ $1,500: ${p.termCap1500} months max`,
          `- Ticket ≤ $2,500: ${p.termCap2500} months max`,
          `- Ticket > $2,500: ${p.termCapOver2500} months max`,
          "",
          "PRICING CONTROLS (ILLUSTRATIVE)",
          `- Money factor (demo): ${p.moneyFactor}`,
          `- Residual percent (demo): ${p.residualPercent} (e.g., 0.20 = 20%)`,
          `- Residual floor (demo): ${fmtUSD(p.residualFloor)}`,
          "",
          "VERIFICATION (DEMO DISCLAIMER)",
          "- No identity verification performed in demo.",
          "- No credit pulls performed in demo.",
          "- No funding or payments performed in demo."
        ].join("\n");
      }

      function buildContractText(d,p,decision,costBasis,residual,payment){
        const dt = new Date();
        const dateStr = `${dt.getMonth()+1}/${dt.getDate()}/${dt.getFullYear()}`;
        const exhibitC = buildExhibitCText(p);

        return [
          "FLINTLOCK FINANCING — SAMPLE CONSUMER LEASE AGREEMENT (DEMO)",
          `Date: ${dateStr}`,
          "",
          "IMPORTANT DEMO NOTICE:",
          "This document is a synthetic example generated for demonstrations and integration testing only.",
          "No financing is offered. No credit pulls occur. Any personal data is synthetic.",
          "",
          "PARTIES",
          "Lessor: Flintlock Financing (Demo Environment)",
          `Lessee: ${d.persona} (Synthetic)`,
          "",
          "ASSET / MERCHANDISE",
          `Item ticket price: ${fmtUSD(d.ticket)}`,
          `Acquisition fee (capitalized): ${fmtUSD(d.acquisitionFee)}`,
          `Sales tax (capitalized): ${fmtUSD(d.tax)}`,
          `Processing (capitalized): ${fmtUSD(d.processingFee)}`,
          `Total Cost Basis: ${fmtUSD(costBasis)}`,
          "",
          "TERM & PAYMENTS (ILLUSTRATIVE)",
          `Term: ${d.term} months`,
          `Estimated Monthly Payment: ${fmtUSD(payment)} (storyboard)`,
          `Money Factor (illustrative): ${p.moneyFactor}`,
          "",
          "PURCHASE OPTION (RESIDUAL)",
          `Purchase option amount at end of term: ${fmtUSD(residual)}`,
          "Early buyout amounts are shown in Exhibit A (straight-line schedule).",
          "",
          "IMPORTANT DISCLOSURES (DEMO)",
          "- This is not a quote, offer, or contract for real financing.",
          "- All calculations are illustrative.",
          "- Actual disclosure language must be reviewed by counsel for Reg M compliance.",
          "",
          "EXHIBITS",
          "Exhibit A: Buyout Schedule (Straight-Line)",
          "Exhibit B: Pricing & Policy Summary (Illustrative)",
          "Exhibit C: Credit Box Summary (One-Page)",
          "",
          "SIGNATURES (DEMO ONLY)",
          "Lessor: ____________________   Date: ________",
          "Lessee: ____________________   Date: ________",
          "",
          "------------------------------",
          exhibitC
        ].join("\n");
      }

      // ---------- Wiring ----------
      function wireGlobalHandlers(){
        // Tabs
        $$(".tab").forEach(btn => {
          btn.addEventListener("click", () => {
            const t = btn.getAttribute("data-tab");
            if (!t) return;
            activeTab = t;
            $$(".tab").forEach(b=>b.classList.toggle("active", b === btn));
            render();
          });
        });

        // Exports
        $("#exportOfferJson").addEventListener("click", () => {
          policy = loadPolicy();
          const costBasis = computeCostBasis(app);
          const decision = decide(app, policy);
          app.term = decision.term;
          const residual = computeResidual(costBasis, policy);
          const payment = computePayment(costBasis, residual, app.term, policy.moneyFactor);
          const snap = buildSnapshot(app, policy, decision, costBasis, residual, payment);
          downloadText("flintlock-offer.json", JSON.stringify(snap, null, 2));
        });

        $("#exportBuyoutCsv").addEventListener("click", () => {
          policy = loadPolicy();
          const costBasis = computeCostBasis(app);
          const decision = decide(app, policy);
          app.term = decision.term;
          const residual = computeResidual(costBasis, policy);
          const schedule = buildBuyoutSchedule(costBasis, residual, app.term);
          const rows = [["month","buyout_amount_usd"], ...schedule.map(([m,a])=>[m, Number(a).toFixed(2)])];
          downloadCsv("flintlock-buyout-schedule.csv", rows);
        });

        // Start button moves to Application tab without rerender-jank
        $("#startBtn").addEventListener("click", (e) => {
          e.preventDefault();
          setTab("application");
          document.getElementById("app").scrollIntoView({behavior:"smooth", block:"start"});
        });

        // Auto-update if /admin writes to localStorage
        window.addEventListener("storage", (ev) => {
          if (ev.key === KEY_POLICY) {
            try { render(); } catch(_) {}
          }
        });
      }

      function setTab(tab){
        activeTab = tab;
        $$(".tab").forEach(b => b.classList.toggle("active", b.getAttribute("data-tab") === tab));
        render();
      }

      // The key fix for your “one character then click again” issue:
      // We DO NOT re-render on each keystroke. We update state, save, and only re-render on blur/change.
      function bindInput(id, key, opts={}){
        const el = document.getElementById(id);
        if (!el) return;

        const isNumber = !!opts.number;

        const commit = () => {
          let v = el.value;
          if (isNumber) v = Number(v);
          app[key] = v;
          saveApp(app);
          render(); // safe to re-render on commit (not every keypress)
        };

        el.addEventListener("change", commit);
        el.addEventListener("blur", commit);

        // Enter commits too
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            el.blur();
          }
        });
      }

      function wireTabSpecificHandlers(costBasis, residual, payment){
        // Application bindings
        if (activeTab === "application"){
          bindInput("persona", "persona");
          bindInput("score", "score", {number:true});
          bindInput("ticket", "ticket", {number:true});
          bindInput("term", "term", {number:true});
          bindInput("acquisitionFee", "acquisitionFee", {number:true});
          bindInput("tax", "tax", {number:true});
          bindInput("processingFee", "processingFee", {number:true});

          const toOffer = $("#toOffer");
          if (toOffer) toOffer.addEventListener("click", () => setTab("offer"));

          const reset = $("#resetDemo");
          if (reset) reset.addEventListener("click", () => {
            app = Object.assign({}, defaultApp);
            saveApp(app);
            render();
          });
        }

        if (activeTab === "offer"){
          const bm = $("#buyoutMonth");
          if (bm){
            bm.addEventListener("change", () => {
              app.buyoutMonth = clamp(bm.value, 0, Number(app.term)||1);
              saveApp(app);
              render();
            });
            bm.addEventListener("blur", () => {
              app.buyoutMonth = clamp(bm.value, 0, Number(app.term)||1);
              saveApp(app);
              render();
            });
          }

          const back = $("#backToApp");
          if (back) back.addEventListener("click", () => setTab("application"));

          const toDisc = $("#toDisclosures");
          if (toDisc) toDisc.addEventListener("click", () => setTab("disclosures"));

          const toContract = $("#toContract");
          if (toContract) toContract.addEventListener("click", () => setTab("contract"));
        }

        if (activeTab === "dashboard"){
          const a = $("#dashToOffer"); if (a) a.addEventListener("click", ()=>setTab("offer"));
          const b = $("#dashToContract"); if (b) b.addEventListener("click", ()=>setTab("contract"));
          const c = $("#dashToExhibitC"); if (c) c.addEventListener("click", ()=>setTab("exhibitC"));
        }

        if (activeTab === "disclosures"){
          const a = $("#discBackOffer"); if (a) a.addEventListener("click", ()=>setTab("offer"));
          const b = $("#discContract"); if (b) b.addEventListener("click", ()=>setTab("contract"));
        }

        if (activeTab === "contract"){
          const dl = $("#dlContract");
          if (dl) dl.addEventListener("click", () => {
            policy = loadPolicy();
            const cb = computeCostBasis(app);
            const decision = decide(app, policy);
            app.term = decision.term;
            const res = computeResidual(cb, policy);
            const pay = computePayment(cb, res, app.term, policy.moneyFactor);
            downloadText("flintlock-contract-demo.txt", buildContractText(app, policy, decision, cb, res, pay));
          });

          const dlC = $("#dlExhibitC");
          if (dlC) dlC.addEventListener("click", () => {
            policy = loadPolicy();
            downloadText("flintlock-exhibit-c.txt", buildExhibitCText(policy));
          });

          const back = $("#contractBackOffer");
          if (back) back.addEventListener("click", ()=>setTab("offer"));
        }

        if (activeTab === "exhibitC"){
          const dl = $("#dlExhibitC2");
          if (dl) dl.addEventListener("click", () => {
            policy = loadPolicy();
            downloadText("flintlock-exhibit-c.txt", buildExhibitCText(policy));
          });
          const back = $("#exBackOffer");
          if (back) back.addEventListener("click", ()=>setTab("offer"));
        }
      }

      // ---------- Boot ----------
      function boot(){
        try{
          wireGlobalHandlers();
          render();
        }catch(err){
          const v = $("#view");
          if (v){
            v.innerHTML = `
              <div class="note err">
                <strong>App render failed.</strong><br/>
                Open DevTools Console to see the error. Quick details:<br/>
                <span class="mono">${escape(err && (err.stack || err.message || String(err)))}</span>
              </div>
            `;
          }
          console.error(err);
        }
      }

      document.addEventListener("DOMContentLoaded", boot);
    })();
  </script>
</body>
</html>
