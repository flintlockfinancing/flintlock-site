<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Flintlock Financing — App Demo</title>
  <meta name="description" content="Synthetic consumer leasing demo (no credit pulls)."/>
  <style>
    :root{
      --bg0:#050F1B; --bg1:#061424; --bg2:#071726;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.04);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.72);
      --muted2: rgba(255,255,255,0.55);
      --line: rgba(255,255,255,0.12);
      --accent:#C57B2A;
      --good:#35d07f;
      --bad:#ff6767;
      --shadow: 0 18px 40px rgba(0,0,0,0.40);
      --radius:18px;
      --max:1100px;
      --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 420px at 18% 0%, rgba(197,123,42,0.18), transparent 55%),
        radial-gradient(720px 380px at 92% 8%, rgba(226,164,93,0.12), transparent 55%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 55%, var(--bg0) 100%);
      line-height:1.45;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:var(--max); margin:0 auto; padding:0 18px}
    .topbar{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(10px);
      background: rgba(5,16,28,0.62);
      border-bottom:1px solid var(--line);
    }
    .hdr{display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap; padding:14px 0}
    .brand{display:flex; align-items:center; gap:10px}
    .mark{
      width:32px; height:32px; border-radius:10px;
      background:
        radial-gradient(10px 10px at 70% 30%, rgba(255,255,255,0.9), transparent 55%),
        radial-gradient(18px 18px at 65% 35%, rgba(226,164,93,0.65), transparent 60%),
        linear-gradient(180deg, rgba(197,123,42,0.95), rgba(197,123,42,0.35));
      box-shadow:0 10px 22px rgba(197,123,42,0.25);
      border:1px solid rgba(255,255,255,0.15);
    }
    .brand-text{display:flex; flex-direction:column; line-height:1.1}
    .brand-text strong{
      font-family:var(--serif);
      letter-spacing:0.08em;
      text-transform:uppercase;
      font-size:12px;
    }
    .brand-text span{font-size:12px; color:rgba(255,255,255,0.55)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex; gap:10px; align-items:center;
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.74);
      font-size:12px;
    }
    .spark{width:8px; height:8px; border-radius:999px; background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(226,164,93,0.95) 35%, rgba(197,123,42,0.5) 65%, transparent 70%); box-shadow:0 0 22px rgba(226,164,93,0.50)}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 13px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      font-size:13px; cursor:pointer; user-select:none; white-space:nowrap;
      transition: transform 0.06s ease, background 0.2s ease, border-color 0.2s ease;
    }
    .btn:hover{background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.20)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(197,123,42,0.55);
      background: linear-gradient(180deg, rgba(197,123,42,0.95), rgba(197,123,42,0.55));
      box-shadow: 0 16px 34px rgba(197,123,42,0.18);
      color:#0b1016; font-weight:900;
    }

    h1{font-family:var(--serif); font-size: clamp(28px, 3.8vw, 44px); margin:22px 0 8px}
    h2{font-family:var(--serif); margin:0 0 8px; font-size:20px}
    .sub{color:var(--muted); font-size:15px; margin:0 0 18px}
    .card{
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin:14px 0;
    }
    .note{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.62);
      font-size:12px;
    }
    .hr{height:1px; background:rgba(255,255,255,0.12); margin:14px 0}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px}
    @media(max-width:980px){ .grid2,.grid3{grid-template-columns:1fr} }
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:rgba(255,255,255,0.72)}
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,0.28);
      border:1px solid rgba(255,255,255,0.14);
      border-radius: 12px;
      padding:10px 12px;
      color: rgba(255,255,255,0.92);
      outline:none;
      font-size:14px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(197,123,42,0.55);
      box-shadow: 0 0 0 3px rgba(197,123,42,0.16);
    }
    .mono{font-family:var(--mono)}
    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .tab{padding:9px 12px; border-radius:999px; border:1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.04); color:rgba(255,255,255,0.78); cursor:pointer; font-size:13px}
    .tab.active{border-color: rgba(197,123,42,0.55); background: rgba(197,123,42,0.14); color: rgba(255,255,255,0.92)}
    .kpi{display:flex; flex-direction:column; gap:4px; padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.03)}
    .kpi .v{font-family:var(--mono); font-size:16px; color:rgba(255,255,255,0.92)}
    .kpi .t{font-size:12px; color:rgba(255,255,255,0.62)}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid rgba(255,255,255,0.12)}
    th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,0.10); font-size:13px}
    th{background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.80); text-align:left}
    tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      font-size:12px;
      color: rgba(255,255,255,0.80);
    }
    .dot{width:8px; height:8px; border-radius:999px; background: rgba(53,208,127,0.95); box-shadow: 0 0 18px rgba(53,208,127,0.25)}
    .dot.bad{background: rgba(255,103,103,0.95); box-shadow: 0 0 18px rgba(255,103,103,0.25)}
    pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      background: rgba(0,0,0,0.28);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      padding:12px;
      color: rgba(255,255,255,0.86);
      font-size:12px;
      line-height:1.4;
    }
    .danger{color: rgba(255,103,103,0.95)}
    .ok{color: rgba(53,208,127,0.95)}
  </style>
</head>
<body>
<header class="topbar">
  <div class="container">
    <div class="hdr">
      <a class="brand" href="/" aria-label="Flintlock Financing Home">
        <div class="mark" aria-hidden="true"></div>
        <div class="brand-text">
          <strong>Flintlock Financing</strong>
          <span>App demo</span>
        </div>
      </a>
      <div class="row">
        <span class="pill"><span class="spark"></span><span>SYNTHETIC DEMO / NO CREDIT PULLS</span></span>
        <a class="btn" href="/admin/">Admin console</a>
        <a class="btn primary" href="#/application">Start application</a>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <h1>Consumer leasing demo</h1>
  <p class="sub">Illustrative terms only. Not a quote or contract.</p>

  <section class="card" id="view"></section>

  <div class="note" style="margin-bottom:24px;">
    <strong>Disclaimer:</strong> Synthetic demo. No funding, no payments, no identity verification, no credit pulls.
  </div>
</main>

<script>
/* -----------------------------
   Flintlock Demo App (static)
   ----------------------------- */

/** Visible error banner so the app never "silently" fails */
(function installErrorBanner(){
  const banner = document.createElement("div");
  banner.style.cssText = "display:none;max-width:1100px;margin:12px auto 0;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,103,103,0.45);background:rgba(255,103,103,0.10);color:rgba(255,255,255,0.92);font:12px ui-monospace,monospace;white-space:pre-wrap;";
  banner.id = "jsErrorBanner";
  document.body.prepend(banner);
  function show(msg){
    banner.style.display = "block";
    banner.textContent = "APP ERROR:\\n" + msg;
  }
  window.addEventListener("error", (e)=> show(e && e.message ? e.message : String(e)));
  window.addEventListener("unhandledrejection", (e)=> show(e && e.reason ? (e.reason.stack || e.reason.message || String(e.reason)) : "unknown rejection"));
})();

const $ = (sel, root=document)=> root.querySelector(sel);
const $$ = (sel, root=document)=> Array.from(root.querySelectorAll(sel));

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function fmtUSD(n){
  const x = Number(n || 0);
  return x.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});
}
function fmtNum(n){
  const x = Number(n || 0);
  return x.toLocaleString(undefined,{maximumFractionDigits:4});
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function round2(n){ return Math.round((Number(n)||0)*100)/100; }

function dlText(filename, text, mime="text/plain"){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
}

const LS_POLICY_KEY = "flintlock_demo_policy_v1";  // shared with /admin
const LS_APP_KEY    = "flintlock_demo_app_v1";     // app form inputs

function defaultPolicy(){
  return {
    minScore: 620,
    maxTicket: 12000,
    termCap1500: 24,
    termCap2500: 36,
    termCapOver2500: 48,
    moneyFactor: 0.003,   // illustrative
    residualPercent: 0.20,
    residualFloor: 200
  };
}

function loadPolicy(){
  try{
    const raw = localStorage.getItem(LS_POLICY_KEY);
    if(!raw) return defaultPolicy();
    const p = JSON.parse(raw);
    return {...defaultPolicy(), ...p};
  }catch(e){
    return defaultPolicy();
  }
}

function saveAppState(s){
  localStorage.setItem(LS_APP_KEY, JSON.stringify(s));
}
function loadAppState(){
  try{
    const raw = localStorage.getItem(LS_APP_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}

function computeTermCap(ticket, p){
  const t = Number(ticket||0);
  if(t <= 1500) return Number(p.termCap1500||24);
  if(t <= 2500) return Number(p.termCap2500||36);
  return Number(p.termCapOver2500||48);
}

function computeResidual(costBasis, p){
  const floor = Number(p.residualFloor||0);
  const pct = Number(p.residualPercent||0);
  return Math.max(floor, round2(costBasis * pct));
}

function computeCostBasis(d){
  return round2(Number(d.ticket||0) + Number(d.acquisitionFee||0) + Number(d.tax||0) + Number(d.processingFee||0));
}

/** Illustrative payment = straight-line depreciation + rent charge (money factor * (cost + residual)) */
function computePayment(costBasis, residual, term, moneyFactor){
  const dep = (costBasis - residual) / Math.max(1, term);
  const rent = (costBasis + residual) * Number(moneyFactor||0);
  return round2(dep + rent);
}

/** Straight-line buyout from cost basis to residual over term. Month elapsed m in [0..term]. */
function buyoutAtMonth(costBasis, residual, term, m){
  const t = Math.max(1, Number(term||1));
  const mm = clamp(Number(m||0), 0, t);
  const step = (costBasis - residual) / t;
  return round2(costBasis - (step * mm));
}

function buildBuyoutSchedule(costBasis, residual, term){
  const rows = [];
  const t = Math.max(1, Number(term||1));
  for(let m=0; m<=t; m++){
    rows.push({month:m, buyout: buyoutAtMonth(costBasis, residual, t, m)});
  }
  return rows;
}

function buyoutScheduleCSV(rows){
  const lines = ["month,buyout_usd"];
  rows.forEach(r=>{
    lines.push([r.month, r.buyout.toFixed(2)].join(","));
  });
  return lines.join("\\n");
}

function creditDecision(d, p){
  const score = Number(d.score||0);
  const ticket = Number(d.ticket||0);
  const maxTicket = Number(p.maxTicket||0);
  const minScore = Number(p.minScore||0);

  const termCap = computeTermCap(ticket, p);
  const term = Math.min(Number(d.term||termCap), termCap);

  const flags = [];
  if(score < minScore) flags.push("Below minimum score");
  if(ticket > maxTicket) flags.push("Above max ticket");

  const approved = flags.length === 0;
  return {approved, flags, termCap, term};
}

function renderTabs(active){
  const tabs = [
    {id:"application", label:"Application"},
    {id:"offer", label:"Offer"},
    {id:"dashboard", label:"Dashboard"},
    {id:"disclosures", label:"Disclosures"},
    {id:"contract", label:"Contract"},
    {id:"creditbox", label:"Exhibit C"}
  ];
  return `<div class="tabs">
    ${tabs.map(t=>{
      const cls = "tab" + (t.id===active ? " active":"");
      return `<a class="${cls}" href="#/${t.id}">${escapeHtml(t.label)}</a>`;
    }).join("")}
  </div>`;
}

function renderApplication(d, p, decision){
  return `
    <div class="card">
      <h2>Application (synthetic)</h2>
      <p class="sub">Enter illustrative applicant + pricing inputs. Values are stored locally in your browser for demo/testing.</p>
      ${renderTabs("application")}
      <div class="hr"></div>

      <div class="grid3">
        <div class="field">
          <label>Persona</label>
          <select id="persona">
            ${["Prime Applicant","Near-Prime Applicant","Thin File Applicant","Decline Scenario"].map(x=> `<option ${d.persona===x?"selected":""}>${escapeHtml(x)}</option>`).join("")}
          </select>
        </div>
        <div class="field">
          <label>Score (synthetic)</label>
          <input id="score" type="number" min="300" max="850" step="1" value="${escapeHtml(d.score)}"/>
        </div>
        <div class="field">
          <label>Item ticket (price)</label>
          <input id="ticket" type="number" min="0" step="1" value="${escapeHtml(d.ticket)}"/>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div class="field">
          <label>Acquisition fee (capitalized)</label>
          <input id="acquisitionFee" type="number" min="0" step="1" value="${escapeHtml(d.acquisitionFee)}"/>
        </div>
        <div class="field">
          <label>Sales tax (capitalized)</label>
          <input id="tax" type="number" min="0" step="1" value="${escapeHtml(d.tax)}"/>
        </div>
        <div class="field">
          <label>Processing (capitalized)</label>
          <input id="processingFee" type="number" min="0" step="1" value="${escapeHtml(d.processingFee)}"/>
        </div>
        <div class="field">
          <label>Term (months) — capped by policy</label>
          <input id="term" type="number" min="1" step="1" value="${escapeHtml(decision.term)}"/>
        </div>
      </div>

      <div class="note">
        <strong>Policy note:</strong> Min score <span class="mono">${escapeHtml(p.minScore)}</span> • Max ticket <span class="mono">${escapeHtml(p.maxTicket)}</span> • Term caps: ≤$1,500 = <span class="mono">${escapeHtml(p.termCap1500)}</span>, ≤$2,500 = <span class="mono">${escapeHtml(p.termCap2500)}</span>, &gt;$2,500 = <span class="mono">${escapeHtml(p.termCapOver2500)}</span>.
      </div>

      <div class="hr"></div>

      <div class="row">
        <a class="btn primary" href="#/offer">Continue to offer</a>
        <button class="btn" id="resetDemo">Reset demo inputs</button>
      </div>

      <div class="note">
        <strong>Compliance note:</strong> “Acquisition fee” is shown as a capitalized component of cost basis for illustrative Reg M alignment in this demo. This is storyboard math only.
      </div>
    </div>
  `;
}

function renderOffer(d, p, decision, pricing){
  const status = decision.approved ? `<span class="badge"><span class="dot"></span>Approved</span>` : `<span class="badge"><span class="dot bad"></span>Declined</span>`;
  return `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
        <div>
          <h2>Offer</h2>
          <p class="sub">Illustrative pricing computed from cost basis and policy settings.</p>
        </div>
        <div>${status}</div>
      </div>

      ${renderTabs("offer")}
      <div class="hr"></div>

      <div class="grid3">
        <div class="kpi">
          <div class="t">Persona</div>
          <div class="v">${escapeHtml(d.persona)}</div>
        </div>
        <div class="kpi">
          <div class="t">Score</div>
          <div class="v">${escapeHtml(String(d.score))}</div>
        </div>
        <div class="kpi">
          <div class="t">Ticket</div>
          <div class="v">${escapeHtml(fmtUSD(d.ticket))}</div>
        </div>
        <div class="kpi">
          <div class="t">Cost basis</div>
          <div class="v">${escapeHtml(fmtUSD(pricing.costBasis))}</div>
        </div>
        <div class="kpi">
          <div class="t">Residual (purchase option)</div>
          <div class="v">${escapeHtml(fmtUSD(pricing.residual))}</div>
        </div>
        <div class="kpi">
          <div class="t">Term</div>
          <div class="v">${escapeHtml(String(pricing.term))} mo</div>
        </div>
      </div>

      <div class="hr"></div>

      ${decision.approved ? `
        <div class="grid2">
          <div class="kpi">
            <div class="t">Estimated monthly payment (illustrative)</div>
            <div class="v">${escapeHtml(fmtUSD(pricing.payment))}</div>
          </div>
          <div class="kpi">
            <div class="t">Money factor (illustrative)</div>
            <div class="v mono">${escapeHtml(fmtNum(p.moneyFactor))}</div>
          </div>
        </div>
      ` : `
        <div class="note">
          <strong>Decline reasons:</strong> ${decision.flags.map(x=> `<span class="danger">${escapeHtml(x)}</span>`).join(" • ")}
        </div>
      `}

      <div class="note">
        <strong>Pricing note (demo):</strong> Payment is computed from straight-line depreciation on cost basis plus an illustrative rent charge using a money factor.
        This is storyboard math only.
      </div>

      <div class="hr"></div>

      <h2>Early buyout (illustrative)</h2>
      <p class="sub">Methodology: <span class="mono">Straight-line buyout</span> from full cost basis down to residual over the term.</p>

      <div class="grid2">
        <div class="field">
          <label>Month elapsed</label>
          <input id="buyoutMonth" type="number" min="0" max="${pricing.term}" step="1" value="${escapeHtml(String(pricing.buyoutMonth))}" />
        </div>
        <div class="field">
          <label>Buyout amount at month <span class="mono">${escapeHtml(String(pricing.buyoutMonth))}</span></label>
          <input value="${escapeHtml(fmtUSD(pricing.buyout))}" disabled />
        </div>
      </div>

      <div class="note">
        <strong>Cost basis components (capitalized):</strong><br/>
        Ticket: <span class="mono">${escapeHtml(fmtUSD(d.ticket))}</span> •
        Acquisition fee: <span class="mono">${escapeHtml(fmtUSD(d.acquisitionFee))}</span> •
        Tax: <span class="mono">${escapeHtml(fmtUSD(d.tax))}</span> •
        Processing: <span class="mono">${escapeHtml(fmtUSD(d.processingFee))}</span>
      </div>

      <div class="hr"></div>

      <h2>Buyout schedule (straight-line)</h2>
      <p class="sub">Straight-line from cost basis to residual over <span class="mono">${escapeHtml(String(pricing.term))}</span> months.</p>

      ${renderBuyoutScheduleTable(pricing.schedule)}

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="exportCSV">Export schedule (CSV)</button>
        <a class="btn" href="#/disclosures">View disclosures</a>
        <a class="btn primary" href="#/contract">Preview contract</a>
      </div>

      <div class="note">
        Demo environment disclaimer: No real credit decisions are made. No credit pulls. No ACH or card transactions.
        Any personal information displayed is synthetic.
      </div>
    </div>
  `;
}

function renderBuyoutScheduleTable(rows){
  const head = `
    <table>
      <thead>
        <tr>
          <th style="width:140px;">Month</th>
          <th class="right">Buyout</th>
        </tr>
      </thead>
      <tbody>
  `;
  const body = rows.map(r=> `
    <tr>
      <td class="mono">${escapeHtml(String(r.month))}</td>
      <td class="right mono">${escapeHtml(fmtUSD(r.buyout))}</td>
    </tr>
  `).join("");
  return head + body + `</tbody></table>`;
}

function renderDashboard(d, p, decision, pricing){
  const status = decision.approved ? `<span class="badge"><span class="dot"></span>Approved</span>` : `<span class="badge"><span class="dot bad"></span>Declined</span>`;
  return `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
        <div>
          <h2>Demo status</h2>
          <p class="sub">Snapshot of the current scenario and policy defaults.</p>
        </div>
        <div>${status}</div>
      </div>

      ${renderTabs("dashboard")}
      <div class="hr"></div>

      <div class="grid3">
        <div class="kpi"><div class="t">Persona</div><div class="v">${escapeHtml(d.persona)}</div></div>
        <div class="kpi"><div class="t">Score</div><div class="v mono">${escapeHtml(String(d.score))}</div></div>
        <div class="kpi"><div class="t">Ticket</div><div class="v mono">${escapeHtml(fmtUSD(d.ticket))}</div></div>
        <div class="kpi"><div class="t">Term cap</div><div class="v mono">${escapeHtml(String(decision.termCap))} mo</div></div>
        <div class="kpi"><div class="t">Min score</div><div class="v mono">${escapeHtml(String(p.minScore))}</div></div>
        <div class="kpi"><div class="t">Max ticket</div><div class="v mono">${escapeHtml(fmtUSD(p.maxTicket))}</div></div>
      </div>

      <div class="note">
        Reminder: This is a synthetic demo. No real identity verification, credit pull, or financing occurs.
      </div>

      <div class="row" style="margin-top:12px;">
        <a class="btn" href="#/application">Application</a>
        <a class="btn" href="#/offer">Offer</a>
        <a class="btn primary" href="#/contract">Contract</a>
      </div>
    </div>
  `;
}

function renderDisclosures(d, p, decision, pricing){
  return `
    <div class="card">
      <h2>Disclosures (illustrative)</h2>
      <p class="sub">Reg M-style summary box for storyboard purposes only.</p>
      ${renderTabs("disclosures")}
      <div class="hr"></div>

      <div class="grid2">
        <div class="kpi"><div class="t">Lease term</div><div class="v mono">${escapeHtml(String(pricing.term))} months</div></div>
        <div class="kpi"><div class="t">Monthly payment (illustrative)</div><div class="v mono">${escapeHtml(fmtUSD(pricing.payment))}</div></div>
        <div class="kpi"><div class="t">Total of payments (approx.)</div><div class="v mono">${escapeHtml(fmtUSD(round2(pricing.payment * pricing.term)))}</div></div>
        <div class="kpi"><div class="t">Purchase option (residual)</div><div class="v mono">${escapeHtml(fmtUSD(pricing.residual))}</div></div>
      </div>

      <div class="note">
        <strong>Important:</strong> This disclosure panel is a demo approximation and is not a substitute for counsel-reviewed Reg M disclosures.
        Values shown are computed using storyboard math and synthetic inputs.
      </div>

      <div class="hr"></div>

      <h2>Cost basis breakdown</h2>
      <div class="grid2">
        <div class="kpi"><div class="t">Ticket</div><div class="v mono">${escapeHtml(fmtUSD(d.ticket))}</div></div>
        <div class="kpi"><div class="t">Acquisition fee (capitalized)</div><div class="v mono">${escapeHtml(fmtUSD(d.acquisitionFee))}</div></div>
        <div class="kpi"><div class="t">Sales tax (capitalized)</div><div class="v mono">${escapeHtml(fmtUSD(d.tax))}</div></div>
        <div class="kpi"><div class="t">Processing (capitalized)</div><div class="v mono">${escapeHtml(fmtUSD(d.processingFee))}</div></div>
        <div class="kpi"><div class="t">Total cost basis</div><div class="v mono">${escapeHtml(fmtUSD(pricing.costBasis))}</div></div>
        <div class="kpi"><div class="t">Residual (purchase option)</div><div class="v mono">${escapeHtml(fmtUSD(pricing.residual))}</div></div>
      </div>

      <div class="row" style="margin-top:12px;">
        <a class="btn" href="#/offer">Back to offer</a>
        <a class="btn primary" href="#/contract">Preview contract</a>
      </div>
    </div>
  `;
}

function renderContract(d, p, decision, pricing){
  const today = new Date().toLocaleDateString();
  const contract = `
FLINTLOCK FINANCING — SAMPLE CONSUMER LEASE AGREEMENT (DEMO)
Date: ${today}

IMPORTANT DEMO NOTICE:
This document is a synthetic example generated for demonstrations and integration testing only.
No financing is offered. No credit pulls occur. Any personal data is synthetic.

PARTIES
Lessor: Flintlock Financing (Demo Environment)
Lessee: ${d.persona} (Synthetic)

ASSET / MERCHANDISE
Item ticket price: ${fmtUSD(d.ticket)}
Acquisition fee (capitalized): ${fmtUSD(d.acquisitionFee)}
Sales tax (capitalized): ${fmtUSD(d.tax)}
Processing (capitalized): ${fmtUSD(d.processingFee)}
Total Cost Basis: ${fmtUSD(pricing.costBasis)}

TERM & PAYMENTS (ILLUSTRATIVE)
Term: ${pricing.term} months
Estimated Monthly Payment: ${fmtUSD(pricing.payment)} (storyboard)
Money Factor (illustrative): ${fmtNum(p.moneyFactor)}

PURCHASE OPTION (RESIDUAL)
Purchase option amount at end of term: ${fmtUSD(pricing.residual)}
Early buyout amounts are shown in Exhibit A (straight-line schedule).

IMPORTANT DISCLOSURES (DEMO)
- This is not a quote, offer, or contract for real financing.
- All calculations are illustrative.
- Actual disclosure language must be reviewed by counsel for Reg M compliance.

EXHIBITS
Exhibit A: Buyout Schedule (Straight-Line)
Exhibit B: Pricing & Policy Summary (Illustrative)
Exhibit C: Credit Box Summary (One-Page)

SIGNATURES (DEMO ONLY)
Lessor: ______________________   Date: __________
Lessee: ______________________   Date: __________
`;

  return `
    <div class="card">
      <h2>Contract preview (demo)</h2>
      <p class="sub">Generated example contract text for bank/investor storyboard and systems integration demos.</p>
      ${renderTabs("contract")}
      <div class="hr"></div>

      <div class="row" style="margin-bottom:10px;">
        <button class="btn" id="downloadContract">Download contract (.txt)</button>
        <a class="btn" href="#/creditbox">View Exhibit C</a>
      </div>

      <pre>${escapeHtml(contract)}</pre>

      <div class="hr"></div>
      <h2>Exhibit A — Buyout schedule</h2>
      <p class="sub">Straight-line from cost basis to residual over term.</p>
      ${renderBuyoutScheduleTable(pricing.schedule)}

      <div class="hr"></div>
      <h2>Exhibit B — Pricing & policy summary</h2>
      <pre>${escapeHtml(JSON.stringify({
        policy: p,
        decision,
        pricing: {
          ticket: d.ticket,
          costBasis: pricing.costBasis,
          residual: pricing.residual,
          term: pricing.term,
          payment: pricing.payment
        }
      }, null, 2))}</pre>

      <div class="note">
        This preview is intentionally plain-text for maximum portability and easy parsing in demos. You can later format into PDF/Doc with a template engine.
      </div>
    </div>
  `;
}

function renderCreditBox(d, p){
  const txt = `
EXHIBIT C — CREDIT BOX SUMMARY (DEMO)

Program Name: Flintlock Financing (Synthetic Demo)
Purpose: Demonstrate policy gating, auditability, and controlled pricing.

ELIGIBILITY (ILLUSTRATIVE)
- Minimum credit score: ${p.minScore}
- Maximum ticket (item price): ${fmtUSD(p.maxTicket)}

TERM CAPS (ILLUSTRATIVE)
- Ticket ≤ $1,500: ${p.termCap1500} months max
- Ticket ≤ $2,500: ${p.termCap2500} months max
- Ticket > $2,500: ${p.termCapOver2500} months max

PRICING CONTROLS (ILLUSTRATIVE)
- Money factor (demo): ${fmtNum(p.moneyFactor)}
- Residual percent (demo): ${fmtNum(p.residualPercent)} (e.g., 0.20 = 20%)
- Residual floor (demo): ${fmtUSD(p.residualFloor)}

VERIFICATION (DEMO DISCLAIMER)
- No identity verification performed in demo.
- No credit pulls performed in demo.
- No funding or payments performed in demo.
`;
  return `
    <div class="card">
      <h2>Exhibit C — Credit box summary</h2>
      <p class="sub">One-page summary for investor/bank pitch materials (synthetic demo).</p>
      ${renderTabs("creditbox")}
      <div class="hr"></div>

      <div class="row" style="margin-bottom:10px;">
        <button class="btn" id="downloadCreditBox">Download Exhibit C (.txt)</button>
        <a class="btn primary" href="#/offer">Back to offer</a>
      </div>

      <pre>${escapeHtml(txt.trim())}</pre>
    </div>
  `;
}

/* ---- Rendering & event wiring ---- */

let renderTimer = null;

/** preserve focus + cursor while we re-render */
function getFocusSnapshot(){
  const el = document.activeElement;
  if(!el) return null;
  const id = el.id;
  if(!id) return null;
  const selStart = (typeof el.selectionStart === "number") ? el.selectionStart : null;
  const selEnd   = (typeof el.selectionEnd === "number") ? el.selectionEnd : null;
  return {id, selStart, selEnd};
}
function restoreFocusSnapshot(snap){
  if(!snap) return;
  const el = document.getElementById(snap.id);
  if(!el) return;
  el.focus({preventScroll:true});
  if(snap.selStart!=null && snap.selEnd!=null && typeof el.setSelectionRange === "function"){
    try{ el.setSelectionRange(snap.selStart, snap.selEnd); }catch(_){}
  }
}

/** Debounced render so typing doesn't break inputs */
function scheduleRender(ms=50){
  clearTimeout(renderTimer);
  renderTimer = setTimeout(render, ms);
}

function currentRoute(){
  const h = (location.hash || "#/application").replace(/^#\/?/, "");
  const seg = h.split("?")[0].trim();
  return seg || "application";
}

function derivePersonaDefaults(persona){
  // simple seeded personas
  if(persona === "Prime Applicant"){
    return {score:720, ticket:4500, acquisitionFee:250, tax:360, processingFee:35, term:48};
  }
  if(persona === "Near-Prime Applicant"){
    return {score:660, ticket:2500, acquisitionFee:200, tax:200, processingFee:35, term:36};
  }
  if(persona === "Thin File Applicant"){
    return {score:635, ticket:1500, acquisitionFee:150, tax:120, processingFee:35, term:24};
  }
  return {score:580, ticket:5000, acquisitionFee:250, tax:400, processingFee:35, term:48};
}

function getState(){
  const saved = loadAppState();
  const base = {
    persona: "Prime Applicant",
    score: 720,
    ticket: 4500,
    acquisitionFee: 250,
    tax: 360,
    processingFee: 35,
    term: 48,
    buyoutMonth: 12
  };
  return {...base, ...(saved||{})};
}

function setState(next){
  saveAppState(next);
}

function render(){
  const view = document.getElementById("view");
  if(!view) return;

  const p = loadPolicy();
  let d = getState();

  // if empty/invalid persona -> normalize
  if(!d.persona) d.persona = "Prime Applicant";

  // enforce numeric coercion
  d.score = Number(d.score||0);
  d.ticket = Number(d.ticket||0);
  d.acquisitionFee = Number(d.acquisitionFee||0);
  d.tax = Number(d.tax||0);
  d.processingFee = Number(d.processingFee||0);
  d.term = Number(d.term||0);
  d.buyoutMonth = Number(d.buyoutMonth||12);

  // apply term caps & decision
  const decision0 = creditDecision(d, p);
  d.term = decision0.term; // enforce capped term

  const costBasis = computeCostBasis(d);
  const residual = computeResidual(costBasis, p);
  const payment = computePayment(costBasis, residual, d.term, p.moneyFactor);
  const schedule = buildBuyoutSchedule(costBasis, residual, d.term);
  const buyoutMonth = clamp(d.buyoutMonth, 0, d.term);
  const buyout = buyoutAtMonth(costBasis, residual, d.term, buyoutMonth);

  const decision = creditDecision(d, p);
  const pricing = {costBasis, residual, term:d.term, payment, schedule, buyoutMonth, buyout};

  const route = currentRoute();
  const snap = getFocusSnapshot();

  let html = "";
  if(route === "application") html = renderApplication(d, p, decision);
  else if(route === "offer") html = renderOffer(d, p, decision, pricing);
  else if(route === "dashboard") html = renderDashboard(d, p, decision, pricing);
  else if(route === "disclosures") html = renderDisclosures(d, p, decision, pricing);
  else if(route === "contract") html = renderContract(d, p, decision, pricing);
  else if(route === "creditbox") html = renderCreditBox(d, p);
  else html = renderApplication(d, p, decision);

  view.innerHTML = html;

  // Wire events AFTER rendering
  wireEvents(d, p, decision, pricing);

  // restore focus to fix the "one character then click again" bug
  restoreFocusSnapshot(snap);
}

function wireEvents(d, p, decision, pricing){
  // Application fields
  const persona = $("#persona");
  if(persona){
    persona.addEventListener("change", ()=>{
      const base = derivePersonaDefaults(persona.value);
      setState({...getState(), persona: persona.value, ...base});
      scheduleRender(10);
    });
  }

  const ids = ["score","ticket","acquisitionFee","tax","processingFee","term"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener("input", ()=>{
      const next = {...getState()};
      next[id] = el.value;
      setState(next);
      scheduleRender(50);
    });
  });

  const buyoutMonth = $("#buyoutMonth");
  if(buyoutMonth){
    buyoutMonth.addEventListener("input", ()=>{
      const next = {...getState()};
      next.buyoutMonth = buyoutMonth.value;
      setState(next);
      scheduleRender(30);
    });
  }

  const reset = $("#resetDemo");
  if(reset){
    reset.addEventListener("click", ()=>{
      localStorage.removeItem(LS_APP_KEY);
      location.hash = "#/application";
      scheduleRender(10);
    });
  }

  const exportCSV = $("#exportCSV");
  if(exportCSV){
    exportCSV.addEventListener("click", ()=>{
      const csv = buyoutScheduleCSV(pricing.schedule);
      dlText("flintlock_buyout_schedule.csv", csv, "text/csv");
    });
  }

  const dlContract = $("#downloadContract");
  if(dlContract){
    dlContract.addEventListener("click", ()=>{
      // regenerate same contract text as preview (simple)
      const today = new Date().toLocaleDateString();
      const contractTxt =
`FLINTLOCK FINANCING — SAMPLE CONSUMER LEASE AGREEMENT (DEMO)
Date: ${today}

IMPORTANT DEMO NOTICE:
This document is a synthetic example generated for demonstrations and integration testing only.

ASSET / MERCHANDISE
Ticket: ${fmtUSD(d.ticket)}
Acquisition fee: ${fmtUSD(d.acquisitionFee)}
Tax: ${fmtUSD(d.tax)}
Processing: ${fmtUSD(d.processingFee)}
Cost Basis: ${fmtUSD(pricing.costBasis)}

TERM & PAYMENTS (ILLUSTRATIVE)
Term: ${pricing.term} months
Estimated Payment: ${fmtUSD(pricing.payment)}
Residual (purchase option): ${fmtUSD(pricing.residual)}

EXHIBITS
Exhibit A: Buyout schedule (straight-line)
Exhibit B: Pricing & policy summary
Exhibit C: Credit box summary
`;
      dlText("flintlock_demo_contract.txt", contractTxt, "text/plain");
    });
  }

  const dlCreditBox = $("#downloadCreditBox");
  if(dlCreditBox){
    dlCreditBox.addEventListener("click", ()=>{
      const txt =
`EXHIBIT C — CREDIT BOX SUMMARY (DEMO)
Minimum score: ${p.minScore}
Max ticket: ${fmtUSD(p.maxTicket)}
Term caps: ≤$1,500=${p.termCap1500} • ≤$2,500=${p.termCap2500} • >$2,500=${p.termCapOver2500}
Money factor: ${fmtNum(p.moneyFactor)}
Residual %: ${fmtNum(p.residualPercent)} • Residual floor: ${fmtUSD(p.residualFloor)}
`;
      dlText("exhibit_c_credit_box_summary.txt", txt, "text/plain");
    });
  }
}

// Route handling
window.addEventListener("hashchange", ()=> scheduleRender(0));

// Boot
(function boot(){
  if(!location.hash) location.hash = "#/application";
  render();
})();
</script>
</body>
</html>
