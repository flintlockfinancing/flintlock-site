<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flintlock Financing | Consumer Demo Portal</title>
  <meta name="description" content="Flintlock Financing consumer demo portal. Synthetic data only. No credit pulls." />

  <style>
    :root{
      --bg: #071726;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.04);
      --text: rgba(255,255,255,0.90);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);
      --line: rgba(255,255,255,0.12);
      --accent: #C57B2A;
      --accent2: #E2A45D;
      --shadow: 0 18px 40px rgba(0,0,0,0.40);
      --radius: 18px;
      --max: 1080px;
      --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --danger: #ff6b6b;
      --warn: #ffd166;
      --ok: #86efac;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 400px at 20% 0%, rgba(197,123,42,0.18), transparent 55%),
        radial-gradient(700px 350px at 90% 10%, rgba(226,164,93,0.12), transparent 55%),
        linear-gradient(180deg, #061424 0%, #071726 55%, #05101C 100%);
      line-height: 1.45;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width: var(--max); margin:0 auto; padding: 0 18px}
    .topbar{
      position: sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(5,16,28,0.62);
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; padding: 14px 0;
      flex-wrap: wrap;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .mark{
      width: 32px; height: 32px; border-radius: 10px;
      background:
        radial-gradient(10px 10px at 70% 30%, rgba(255,255,255,0.9), transparent 55%),
        radial-gradient(18px 18px at 65% 35%, rgba(226,164,93,0.65), transparent 60%),
        linear-gradient(180deg, rgba(197,123,42,0.95), rgba(197,123,42,0.35));
      box-shadow: 0 10px 22px rgba(197,123,42,0.25);
      border: 1px solid rgba(255,255,255,0.15);
    }
    .brand-text{display:flex; flex-direction:column; line-height:1.1}
    .brand-text strong{
      font-family: var(--serif);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
    }
    .brand-text span{font-size:12px; color: var(--muted2)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex; gap:10px; align-items:center;
      padding: 7px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 12px;
    }
    .spark{
      width: 8px; height: 8px; border-radius: 999px;
      background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(226,164,93,0.95) 35%, rgba(197,123,42,0.5) 65%, transparent 70%);
      box-shadow: 0 0 22px rgba(226,164,93,0.50);
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding: 10px 13px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      font-size: 13px;
      cursor:pointer;
      transition: transform 0.06s ease, background 0.2s ease, border-color 0.2s ease;
      user-select:none; white-space:nowrap;
    }
    .btn:hover{background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.20)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(197,123,42,0.55);
      background: linear-gradient(180deg, rgba(197,123,42,0.95), rgba(197,123,42,0.55));
      box-shadow: 0 16px 34px rgba(197,123,42,0.18);
      color: #0b1016;
      font-weight: 800;
    }
    .btn.ghost{background:transparent}
    .card{
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    h1{
      font-family: var(--serif);
      font-size: clamp(22px, 3.2vw, 34px);
      margin: 18px 0 6px;
    }
    h2{
      font-family: var(--serif);
      margin: 0 0 8px;
      font-size: 20px;
    }
    .sub{color: var(--muted); font-size: 14px; margin: 0 0 14px}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap: 12px}
    .grid3{display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px}
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size: 12px; color: var(--muted2)}
    input, select, textarea{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.92);
      outline:none;
      font-size: 14px;
    }
    textarea{min-height: 90px; resize: vertical}
    .hr{height:1px; background: rgba(255,255,255,0.08); margin: 12px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.80);
      font-size: 12px;
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(134,239,172,0.25); background: rgba(134,239,172,0.08)}
    .badge.warn{border-color: rgba(255,209,102,0.25); background: rgba(255,209,102,0.08)}
    .badge.bad{border-color: rgba(255,107,107,0.25); background: rgba(255,107,107,0.08)}
    .note{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      color: var(--muted2);
      font-size: 12px;
    }

    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px}
    .tab{
      padding: 9px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(197,123,42,0.40);
      background: rgba(197,123,42,0.10);
    }

    table{width:100%; border-collapse: collapse; font-size: 13px}
    th, td{padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.07)}
    th{text-align:left; color: rgba(255,255,255,0.80); font-weight: 700; background: rgba(255,255,255,0.03)}
    .right{text-align:right}

    @media (max-width: 980px){
      .grid2, .grid3{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="container">
      <div class="topbar-inner">
        <a class="brand" href="/" aria-label="Flintlock Financing Home">
          <div class="mark" aria-hidden="true"></div>
          <div class="brand-text">
            <strong>Flintlock Financing</strong>
            <span>Consumer demo portal</span>
          </div>
        </a>

        <div class="row">
          <span class="pill"><span class="spark" aria-hidden="true"></span><span>DEMO / TEST ENVIRONMENT</span></span>
          <a class="btn" href="/admin">Admin console</a>
          <a class="btn primary" href="#/application">Start application</a>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <h1>Disciplined, policy-driven consumer leasing</h1>
    <p class="sub">
      Synthetic demo only. No real credit decisions. No credit pulls. No identity verification. No payments.
      Use personas to storyboard the end-to-end flow.
    </p>

    <section class="card" id="view"></section>

    <div class="note" style="margin-bottom: 24px;">
      <strong>Demo environment disclaimer:</strong> All applicant data is synthetic. Any “offer math” is illustrative only.
      This portal is for product demos and diligence walkthroughs.
    </div>
  </main>

<script>
(() => {
  // -----------------------------
  // Policy: loaded from Admin (same origin) or default
  // -----------------------------
  const DEFAULT_POLICY = {
    minScore: 620,
    maxTicket: 12000,
    termCaps: [
      { max: 1500, term: 24 },
      { max: 2500, term: 36 },
      { max: Infinity, term: 48 }
    ],
    residualPct: 0.20,
    residualFloor: 200,
    moneyFactor: 0.0030
  };

  const ADMIN_POLICY_KEY = "flintlock_demo_policy_v1";

  function loadPolicy(){
    try{
      const raw = localStorage.getItem(ADMIN_POLICY_KEY);
      if(!raw) return structuredClone(DEFAULT_POLICY);
      const p = JSON.parse(raw);

      const termCaps = Array.isArray(p.termCaps) && p.termCaps.length >= 3
        ? [
            { max: Number(p.termCaps[0].max ?? 1500), term: Number(p.termCaps[0].term ?? 24) },
            { max: Number(p.termCaps[1].max ?? 2500), term: Number(p.termCaps[1].term ?? 36) },
            { max: Infinity, term: Number(p.termCaps[2].term ?? 48) },
          ]
        : structuredClone(DEFAULT_POLICY.termCaps);

      return {
        minScore: Number(p.minScore ?? DEFAULT_POLICY.minScore),
        maxTicket: Number(p.maxTicket ?? DEFAULT_POLICY.maxTicket),
        termCaps,
        residualPct: Number(p.residualPct ?? DEFAULT_POLICY.residualPct),
        residualFloor: Number(p.residualFloor ?? DEFAULT_POLICY.residualFloor),
        moneyFactor: Number(p.moneyFactor ?? DEFAULT_POLICY.moneyFactor),
      };
    } catch(e){
      return structuredClone(DEFAULT_POLICY);
    }
  }

  let POLICY = loadPolicy();

  // -----------------------------
  // Personas (synthetic)
  // -----------------------------
  const PERSONAS = [
    { id:"prime", name:"Prime Applicant", score:720, flags:{ fraud:false, idMismatch:false }, blurb:"Typical approval path. Use to walk through offer + disclosures." },
    { id:"near",  name:"Near Prime Applicant", score:640, flags:{ fraud:false, idMismatch:false }, blurb:"Closer to policy minimum; useful to demonstrate thresholding." },
    { id:"fraud", name:"Fraud Flag", score:700, flags:{ fraud:true, idMismatch:false }, blurb:"Routes to manual review (demo)." },
    { id:"idm",   name:"Identity Mismatch", score:700, flags:{ fraud:false, idMismatch:true }, blurb:"Declines due to identity mismatch (demo)." },
    { id:"below", name:"Below Minimum Score", score:590, flags:{ fraud:false, idMismatch:false }, blurb:"Declines due to policy minimum score." },
  ];

  // -----------------------------
  // State
  // -----------------------------
  const state = {
    personaId: "prime",
    applicant: {
      name: "Alex Morgan",
      email: "alex.morgan@example.com",
      phone: "(555) 555-1212",
      address1: "100 Market St",
      city: "Houston",
      state: "TX",
      postal: "77002"
    },
    purchase: {
      itemDescription: "Illustrative Merchant Item",
      price: 4500,            // ticket (item price)
      acquisitionFee: 0,      // renamed from origination fee
      tax: 0,
      processingFee: 0
    },
    decision: null, // set after evaluation
    ui: {
      buyoutMonth: 12
    }
  };

  // -----------------------------
  // Utilities
  // -----------------------------
  const viewEl = document.getElementById("view");

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  const fmtUSD = (n) => new Intl.NumberFormat("en-US", { style:"currency", currency:"USD" }).format(Number(n||0));
  const mono = (s) => `<span class="mono">${escapeHtml(s)}</span>`;
  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
  const round2 = (n) => Math.round(Number(n||0) * 100) / 100;

  function route(){
    const h = location.hash || "#/dashboard";
    if(h.startsWith("#/application")) return "application";
    if(h.startsWith("#/offer")) return "offer";
    return "dashboard";
  }

  function activePersona(){
    return PERSONAS.find(p => p.id === state.personaId) || PERSONAS[0];
  }

  function computeTerm(ticket){
    for(const cap of POLICY.termCaps){
      if(ticket <= cap.max) return cap.term;
    }
    return POLICY.termCaps[POLICY.termCaps.length-1].term;
  }

  function computeResidual(costBasis){
    const r = costBasis * POLICY.residualPct;
    return Math.max(POLICY.residualFloor, Math.round(r));
  }

  function computePayment(costBasis, residual, term){
    // Illustrative lease math: depreciation + rent
    const dep = (costBasis - residual) / term;
    const rent = (costBasis + residual) * POLICY.moneyFactor;
    return round2(dep + rent);
  }

  // Straight-line buyout (matches your Excel method):
  // Declines from cost basis to residual over term months.
  function buyoutAtMonth(costBasis, residual, term, monthElapsed){
    const m = clamp(Number(monthElapsed||0), 0, term);
    return residual + (costBasis - residual) * ((term - m) / term);
  }

  function badgeForOutcome(outcome){
    if(outcome === "APPROVE") return { cls:"ok", text:"Approved" };
    if(outcome === "MANUAL_REVIEW") return { cls:"warn", text:"Manual review" };
    return { cls:"bad", text:"Declined" };
  }

  // -----------------------------
  // Decision logic (demo)
  // -----------------------------
  function evaluate(){
    POLICY = loadPolicy(); // keep in sync with admin changes (same origin)

    const persona = activePersona();

    const ticket = Number(state.purchase.price || 0);
    const acquisitionFee = Number(state.purchase.acquisitionFee || 0);
    const tax = Number(state.purchase.tax || 0);
    const processingFee = Number(state.purchase.processingFee || 0);

    const costBasis = ticket + acquisitionFee + tax + processingFee;

    const reasons = [];

    // Basic validations
    if(ticket <= 0) reasons.push("Invalid item price.");
    if(ticket > POLICY.maxTicket) reasons.push(`Item price exceeds policy maximum (${fmtUSD(POLICY.maxTicket)}).`);
    if(persona.score < POLICY.minScore) reasons.push(`Score below policy minimum (${POLICY.minScore}).`);

    // Demo flags
    if(persona.flags.idMismatch){
      return makeDecision({
        outcome: "DECLINE",
        summary: "Declined due to identity mismatch (demo).",
        reasons: ["Identity verification mismatch (demo).", ...reasons],
        persona, ticket, acquisitionFee, tax, processingFee, costBasis
      });
    }

    if(persona.flags.fraud){
      return makeDecision({
        outcome: "MANUAL_REVIEW",
        summary: "Routed to manual review due to fraud indicator (demo).",
        reasons,
        persona, ticket, acquisitionFee, tax, processingFee, costBasis
      });
    }

    if(reasons.length){
      return makeDecision({
        outcome: "DECLINE",
        summary: "Declined due to policy constraints.",
        reasons,
        persona, ticket, acquisitionFee, tax, processingFee, costBasis
      });
    }

    return makeDecision({
      outcome: "APPROVE",
      summary: "Approved per current policy.",
      reasons: [],
      persona, ticket, acquisitionFee, tax, processingFee, costBasis
    });
  }

  function makeDecision({ outcome, summary, reasons, persona, ticket, acquisitionFee, tax, processingFee, costBasis }){
    const term = computeTerm(ticket);                // term caps based on item price (ticket)
    const residual = computeResidual(costBasis);     // residual based on full cost basis
    const payment = computePayment(costBasis, residual, term);
    const totalOfPayments = round2(payment * term);

    const d = {
      outcome,
      summary,
      reasons,
      personaId: persona.id,
      personaName: persona.name,
      score: persona.score,
      flags: persona.flags,
      itemDescription: state.purchase.itemDescription,
      ticket,
      acquisitionFee,
      tax,
      processingFee,
      costBasis,
      term,
      residual,
      payment,
      totalOfPayments,
      evaluatedAt: new Date().toISOString()
    };

    state.decision = d;
    return d;
  }

  // -----------------------------
  // Rendering
  // -----------------------------
  function renderTabs(active){
    return `
      <div class="tabs" role="tablist" aria-label="Demo navigation">
        <a class="tab ${active==="application"?"active":""}" href="#/application" role="tab">Application</a>
        <a class="tab ${active==="offer"?"active":""}" href="#/offer" role="tab">Offer</a>
        <a class="tab ${active==="dashboard"?"active":""}" href="#/dashboard" role="tab">Dashboard</a>
      </div>
    `;
  }

  function renderDashboard(){
    const d = state.decision || evaluate();
    const badge = badgeForOutcome(d.outcome);

    const buyoutMonth = clamp(Number(state.ui.buyoutMonth || 12), 0, d.term);
    const buyout = round2(buyoutAtMonth(d.costBasis, d.residual, d.term, buyoutMonth));

    viewEl.innerHTML = `
      <h2>Demo status</h2>
      <p class="sub">Snapshot of the current scenario and policy defaults.</p>

      <div class="row">
        <span class="badge ${badge.cls}">${badge.text}</span>
        <span class="badge">Evaluated ${mono(d.evaluatedAt)}</span>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div class="card">
          <div class="field">
            <label>Persona</label>
            <div class="mono" style="font-size:14px;">${escapeHtml(d.personaName)}</div>
          </div>
        </div>
        <div class="card">
          <div class="field">
            <label>Score</label>
            <div class="mono" style="font-size:14px;">${escapeHtml(String(d.score))}</div>
          </div>
        </div>

        <div class="card">
          <div class="field">
            <label>Ticket (item price)</label>
            <div class="mono" style="font-size:14px;">${escapeHtml(fmtUSD(d.ticket))}</div>
          </div>
        </div>
        <div class="card">
          <div class="field">
            <label>Term cap</label>
            <div class="mono" style="font-size:14px;">${escapeHtml(String(d.term))} mo</div>
          </div>
        </div>

        <div class="card">
          <div class="field">
            <label>Min score</label>
            <div class="mono" style="font-size:14px;">${escapeHtml(String(POLICY.minScore))}</div>
          </div>
        </div>
        <div class="card">
          <div class="field">
            <label>Max ticket</label>
            <div class="mono" style="font-size:14px;">${escapeHtml(fmtUSD(POLICY.maxTicket))}</div>
          </div>
        </div>
      </div>

      <div class="note">
        <strong>Reminder:</strong> This is a synthetic demo. No real identity verification, credit pull, or financing occurs.
      </div>

      ${renderTabs("dashboard")}

      <div class="hr"></div>

      <h2>Offer summary (illustrative)</h2>
      <div class="grid3">
        <div class="card">
          <label>Monthly payment</label>
          <div class="mono" style="font-size:16px; margin-top:4px;">${escapeHtml(fmtUSD(d.payment))}</div>
        </div>
        <div class="card">
          <label>Residual (purchase option)</label>
          <div class="mono" style="font-size:16px; margin-top:4px;">${escapeHtml(fmtUSD(d.residual))}</div>
        </div>
        <div class="card">
          <label>Cost basis</label>
          <div class="mono" style="font-size:16px; margin-top:4px;">${escapeHtml(fmtUSD(d.costBasis))}</div>
        </div>
      </div>

      <div class="note">
        <strong>Pricing note (demo):</strong> Payment is computed from straight-line depreciation on cost basis plus an illustrative rent charge using a money factor.
        This is storyboard math only.
      </div>

      <div class="hr"></div>

      <h2>Early buyout (illustrative)</h2>
      <p class="sub">
        Methodology: <span class="mono">Straight-line buyout</span> from full cost basis down to residual over the term.
        (Matches the Excel approach you described.)
      </p>

      <div class="grid2">
        <div class="field">
          <label>Month elapsed</label>
          <input id="buyoutMonth" type="number" min="0" max="${d.term}" step="1" value="${buyoutMonth}" />
        </div>
        <div class="field">
          <label>Buyout amount at month ${buyoutMonth}</label>
          <input value="${fmtUSD(buyout)}" disabled />
        </div>
      </div>

      <div class="note">
        <strong>Cost basis components (capitalized):</strong><br/>
        Ticket: ${mono(fmtUSD(d.ticket))} • Acquisition fee: ${mono(fmtUSD(d.acquisitionFee))} • Tax: ${mono(fmtUSD(d.tax))} • Processing: ${mono(fmtUSD(d.processingFee))}
      </div>

      <div class="row" style="margin-top:12px;">
        <a class="btn" href="#/offer">View full offer</a>
        <button class="btn primary" id="btnReset">Reset demo</button>
      </div>
    `;

    document.getElementById("buyoutMonth").addEventListener("input", (e) => {
      state.ui.buyoutMonth = Number(e.target.value || 0);
      renderDashboard();
    });

    document.getElementById("btnReset").addEventListener("click", () => {
      state.personaId = "prime";
      state.purchase.price = 4500;
      state.purchase.acquisitionFee = 0;
      state.purchase.tax = 0;
      state.purchase.processingFee = 0;
      state.decision = null;
      location.hash = "#/dashboard";
      renderAll();
    });
  }

  function renderOffer(){
    const d = state.decision || evaluate();
    const badge = badgeForOutcome(d.outcome);

    viewEl.innerHTML = `
      <h2>Offer & disclosures (illustrative)</h2>
      <p class="sub">
        This screen demonstrates how key terms can be displayed. Values are synthetic and for storyboard purposes only.
      </p>

      <div class="row">
        <span class="badge ${badge.cls}">${badge.text}</span>
        <span class="badge">Term ${mono(String(d.term))} mo</span>
        <span class="badge">Payment ${mono(fmtUSD(d.payment))}</span>
        <span class="badge">Residual ${mono(fmtUSD(d.residual))}</span>
      </div>

      <div class="hr"></div>

      <div class="card">
        <h2 style="margin:0 0 8px;">Transaction details</h2>
        <div class="grid2">
          <div class="field">
            <label>Item</label>
            <input value="${escapeHtml(d.itemDescription)}" disabled />
          </div>
          <div class="field">
            <label>Persona / score (synthetic)</label>
            <input value="${escapeHtml(d.personaName)} • ${escapeHtml(String(d.score))}" disabled />
          </div>
        </div>

        <div class="hr"></div>

        <h2 style="margin:0 0 8px;">Cost basis (capitalized)</h2>
        <div style="overflow:auto; border:1px solid rgba(255,255,255,0.10); border-radius:14px;">
          <table>
            <thead>
              <tr>
                <th>Component</th>
                <th class="right">Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Ticket (item price)</td><td class="right mono">${escapeHtml(fmtUSD(d.ticket))}</td></tr>
              <tr><td>Acquisition fee</td><td class="right mono">${escapeHtml(fmtUSD(d.acquisitionFee))}</td></tr>
              <tr><td>Sales tax</td><td class="right mono">${escapeHtml(fmtUSD(d.tax))}</td></tr>
              <tr><td>Processing fee</td><td class="right mono">${escapeHtml(fmtUSD(d.processingFee))}</td></tr>
              <tr><th>Total cost basis</th><th class="right mono">${escapeHtml(fmtUSD(d.costBasis))}</th></tr>
            </tbody>
          </table>
        </div>

        <div class="note">
          <strong>Compliance posture (demo copy):</strong> Fees shown as <span class="mono">Acquisition fee</span> are capitalized into the lease cost basis (not a dealer fee).
          Actual disclosure requirements depend on program structure and applicable law.
        </div>

        <div class="hr"></div>

        <h2 style="margin:0 0 8px;">Illustrative payment math</h2>
        <div class="grid3">
          <div class="field">
            <label>Monthly payment</label>
            <input value="${fmtUSD(d.payment)}" disabled />
          </div>
          <div class="field">
            <label>Total of payments</label>
            <input value="${fmtUSD(d.totalOfPayments)}" disabled />
          </div>
          <div class="field">
            <label>Purchase option (residual)</label>
            <input value="${fmtUSD(d.residual)}" disabled />
          </div>
        </div>

        <div class="note">
          <strong>Important (demo):</strong> This is storyboard math. It is not a disclosure, quote, or contract.
        </div>
      </div>

      ${renderTabs("offer")}

      <div class="row" style="margin-top:12px;">
        <a class="btn" href="#/application">Back to application</a>
        <a class="btn primary" href="#/dashboard">View dashboard</a>
      </div>
    `;
  }

  function renderApplication(){
    POLICY = loadPolicy(); // keep in sync with admin changes

    const persona = activePersona();

    viewEl.innerHTML = `
      <h2>Application (synthetic)</h2>
      <p class="sub">
        Select a persona to simulate credit and risk flags. Enter capitalized fees to match your Excel cost-basis methodology.
      </p>

      <div class="card">
        <h2 style="margin:0 0 8px;">Persona selector</h2>
        <div class="grid2">
          <div class="field">
            <label>Persona</label>
            <select id="persona">
              ${PERSONAS.map(p => `
                <option value="${escapeHtml(p.id)}" ${p.id===state.personaId ? "selected" : ""}>
                  ${escapeHtml(p.name)} (score ${p.score}${p.flags.fraud ? ", fraud" : ""}${p.flags.idMismatch ? ", id mismatch" : ""})
                </option>
              `).join("")}
            </select>
          </div>
          <div class="field">
            <label>Persona description</label>
            <input value="${escapeHtml(persona.blurb)}" disabled />
          </div>
        </div>

        <div class="note">
          Flags: ${mono("fraud=" + (persona.flags.fraud ? "true" : "false"))}, ${mono("idMismatch=" + (persona.flags.idMismatch ? "true" : "false"))}
        </div>

        <div class="hr"></div>

        <h2 style="margin:0 0 8px;">Applicant (synthetic)</h2>
        <div class="grid2">
          <div class="field"><label>Name</label><input id="name" value="${escapeHtml(state.applicant.name)}"/></div>
          <div class="field"><label>Email</label><input id="email" value="${escapeHtml(state.applicant.email)}"/></div>
          <div class="field"><label>Phone</label><input id="phone" value="${escapeHtml(state.applicant.phone)}"/></div>
          <div class="field"><label>Address</label><input id="address1" value="${escapeHtml(state.applicant.address1)}"/></div>
          <div class="field"><label>City</label><input id="city" value="${escapeHtml(state.applicant.city)}"/></div>
          <div class="field"><label>State</label><input id="st" value="${escapeHtml(state.applicant.state)}"/></div>
          <div class="field"><label>Postal</label><input id="postal" value="${escapeHtml(state.applicant.postal)}"/></div>
        </div>

        <div class="hr"></div>

        <h2 style="margin:0 0 8px;">Item / transaction</h2>
        <div class="grid2">
          <div class="field">
            <label>Item description</label>
            <input id="itemDescription" value="${escapeHtml(state.purchase.itemDescription)}" />
          </div>
          <div class="field">
            <label>Item price (ticket) (max ${fmtUSD(POLICY.maxTicket)})</label>
            <input id="price" type="number" min="1" max="${POLICY.maxTicket}" step="1" value="${Number(state.purchase.price||0)}" />
          </div>

          <div class="field">
            <label>Acquisition fee (capitalized)</label>
            <input id="acquisitionFee" type="number" min="0" step="1" value="${Number(state.purchase.acquisitionFee||0)}" />
          </div>
          <div class="field">
            <label>Sales tax (capitalized)</label>
            <input id="tax" type="number" min="0" step="1" value="${Number(state.purchase.tax||0)}" />
          </div>

          <div class="field">
            <label>Processing fee (capitalized)</label>
            <input id="processingFee" type="number" min="0" step="1" value="${Number(state.purchase.processingFee||0)}" />
          </div>

          <div class="field">
            <label>Total cost basis</label>
            <input value="${fmtUSD(
              Number(state.purchase.price||0) +
              Number(state.purchase.acquisitionFee||0) +
              Number(state.purchase.tax||0) +
              Number(state.purchase.processingFee||0)
            )}" disabled />
          </div>
        </div>

        <div class="note">
          <strong>Policy summary:</strong>
          min score ${mono(String(POLICY.minScore))} • max ticket ${mono(fmtUSD(POLICY.maxTicket))} • term caps
          ${mono(POLICY.termCaps.map(c => (c.max===Infinity ? "else" : "<="+c.max) + ":" + c.term).join(", "))}
        </div>

        <div class="row" style="margin-top: 12px;">
          <button class="btn primary" id="btnSubmit">Submit (demo)</button>
          <a class="btn" href="#/dashboard">Skip to dashboard</a>
        </div>
      </div>

      ${renderTabs("application")}
    `;

    // bind controls
    document.getElementById("persona").addEventListener("change", (e)=> {
      state.personaId = e.target.value;
      state.decision = null;
      renderApplication();
    });

    const bind = (id, path, parser) => {
      document.getElementById(id).addEventListener("input", (e)=> {
        const v = parser ? parser(e.target.value) : e.target.value;
        setPath(path, v);
        state.decision = null;
        // keep total basis display live by rerendering quickly
        renderApplication();
      });
    };

    bind("name", "applicant.name");
    bind("email", "applicant.email");
    bind("phone", "applicant.phone");
    bind("address1", "applicant.address1");
    bind("city", "applicant.city");
    bind("st", "applicant.state");
    bind("postal", "applicant.postal");
    bind("itemDescription", "purchase.itemDescription");
    bind("price", "purchase.price", (v)=>Number(v||0));
    bind("acquisitionFee", "purchase.acquisitionFee", (v)=>Number(v||0));
    bind("tax", "purchase.tax", (v)=>Number(v||0));
    bind("processingFee", "purchase.processingFee", (v)=>Number(v||0));

    document.getElementById("btnSubmit").addEventListener("click", () => {
      const d = evaluate();
      // Route based on outcome for demo
      if(d.outcome === "APPROVE") location.hash = "#/offer";
      else location.hash = "#/dashboard";
      renderAll();
    });
  }

  function setPath(path, value){
    const parts = path.split(".");
    let obj = state;
    for(let i=0;i<parts.length-1;i++){
      obj = obj[parts[i]];
    }
    obj[parts[parts.length-1]] = value;
  }

  // -----------------------------
  // Router
  // -----------------------------
  function renderAll(){
    POLICY = loadPolicy();

    const r = route();
    if(r === "application") return renderApplication();
    if(r === "offer") return renderOffer();
    return renderDashboard();
  }

  window.addEventListener("hashchange", renderAll);

  if(!location.hash) location.hash = "#/dashboard";
  renderAll();
})();
</script>
</body>
</html>
